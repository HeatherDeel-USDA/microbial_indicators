---
title: "Machine Learning Graphing"
author: "Heather Deel"
date: "2023-09-18"
output: html_document
---

### Libraries
```{r}
library(ggplot2)
library(readxl)
library(ggpubr)
library(paletteer)
library(tidyverse)
```

### Comparison of taxonomic and EC relative abundance and total data
```{r}
# compare the r^2 distributions of 1-25 models
# just clean up the same figure Dan made

```

### Boxplot of R^2 values for each indicator
```{r}
ml_stats <- read.csv("machine_learning/16S_EC/All_EC_RA_total_corr_stats.csv")
ml_stats_RA <- ml_stats[ml_stats$RA_total == "RA",]
ml_stats_total <- ml_stats[ml_stats$RA_total == "total",]


stat.test.RA <- compare_means(r2_val ~ myVar,
                           data = ml_stats_RA,
                           method = 'wilcox.test',
                           p.adj = 'fdr')
stat.test.total <- compare_means(r2_val ~ myVar,
                           data = ml_stats_total,
                           method = 'wilcox.test',
                           p.adj = 'fdr')
stat.test.RA$Comparison <- paste0(stat.test.RA$group1, " - ", stat.test.RA$group2)
stat.test.total$Comparison <- paste0(stat.test.total$group1, " - ", stat.test.total$group2)
groups.RA <- rcompanion::cldList(p.adj ~ Comparison,
                              data = stat.test.RA,
                              threshold = 0.05)
groups.total <- rcompanion::cldList(p.adj ~ Comparison,
                              data = stat.test.total,
                              threshold = 0.05)
  
groups.RA$y <- 1.2
groups.total$y <- 1.2

p1 <- ggplot(ml_stats_RA, aes(x=myVar, y=r2_val)) + 
  geom_boxplot(fill='grey') + 
  labs(y='R^2 Values', x='Indicator', title = "EC Model Prediction Accuracy, Relative Abundance") + 
  theme_bw() + 
  ylim(0,1.2) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  geom_text(inherit.aes=F, data=groups.RA, aes(x=Group, y=y, label=Letter)) # add significances
p1

ggsave("figures/ml_ec_r2_RA.pdf", unit = "in", width = 8, height = 6, dpi = 300, device = "pdf")
ggsave("figures/ml_ec_r2_RA.tiff", unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

p2 <- ggplot(ml_stats_total, aes(x=myVar, y=r2_val)) + 
  geom_boxplot(fill='grey') + 
  labs(y='R^2 Values', x='Indicator', title = "EC Model Prediction Accuracy, Total Abundance") + 
  theme_bw() + 
  ylim(0,1.2) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  geom_text(inherit.aes=F, data=groups.total, aes(x=Group, y=y, label=Letter)) # add significances
p2

ggsave("figures/ml_ec_r2_total.pdf", unit = "in", width = 8, height = 6, dpi = 300, device = "pdf")
ggsave("figures/ml_ec_r2_total.tiff", unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")
```

### Feature importance distributions
```{r}
gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs$EC <- gsub(":","_", gibbs$EC)
gibbs$EC <- gsub("\\.","_", gibbs$EC)

myVars <- c('ace', 'SOM', 'activeC', 'resp', 'agg_stab', 'water_cap', 'ph', 'p', 'k', 'mg', 'fe', 'mn', 'zn')

### ace
myVar <- 'ace'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_ace <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_ace$Indicator <- "ACE"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### SOM
myVar <- 'SOM'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_SOM <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_SOM$Indicator <- "SOM"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### activeC
myVar <- 'activeC'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_activeC <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_activeC$Indicator <- "Active C"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### resp
myVar <- 'resp'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_resp <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_resp$Indicator <- "Respiration"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### agg_stab
myVar <- 'agg_stab'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_aggstab <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_aggstab$Indicator <- "Aggregate Stability"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### water_cap
myVar <- 'water_cap'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_watercap <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_watercap$Indicator <- "Water Capacity"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### ph
myVar <- 'ph'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_ph <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_ph$Indicator <- "pH"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### p
myVar <- 'p'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_p <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_p$Indicator <- "P"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### k
myVar <- 'k'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_k <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_k$Indicator <- "K"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 10, height = 6, dpi = 300, device = "tiff")

### mg
myVar <- 'mg'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_mg <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_mg$Indicator <- "Mg"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### fe
myVar <- 'fe'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_fe <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_fe$Indicator <- "Fe"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### mn
myVar <- 'mn'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_mn <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_mn$Indicator <- "Mn"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### zn
myVar <- 'zn'

df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
names(df) <- c('Predictor', 'VIP', 'Run')

gDF <- df %>%
  left_join(gibbs, by=c("Predictor"="EC")) %>% 
  mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

gDF <- gDF %>% group_by(Predictor) %>%
  mutate(Var = mean(VIP)) %>%
  filter(Var > 0.01) %>% select(-Var) # filter out poor indicators

gDF_avg_zn <- gDF %>% 
  group_by(Predictor) %>% 
  summarize(VIP_avg = mean(VIP))
gDF_avg_zn$Indicator <- "Zn"

colors <- paletteer_d(`"ggsci::category20_d3"`)

p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
  scale_fill_manual(values=colors, na.value="white") +
  geom_boxplot() + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="", y="Variable Importance", title = myVar)
p
ggsave(paste0("figures/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")

### make list of varimp averages from all indicators
varimps_all <- rbind(gDF_avg_ace, gDF_avg_activeC, gDF_avg_aggstab, gDF_avg_fe,
                     gDF_avg_k, gDF_avg_mg, gDF_avg_mn, gDF_avg_p, gDF_avg_ph,
                     gDF_avg_resp, gDF_avg_SOM, gDF_avg_watercap, gDF_avg_zn)
write.csv(varimps_all, file = "machine_learning/16S_EC/all_varimps_list.csv", row.names = FALSE)
```

### Partial dependence plots
```{r}
# show response of important features to each indicator
# just do this on a final model
```

