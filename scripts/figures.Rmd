---
title: "Machine Learning Graphing"
author: "Heather Deel"
date: "2023-09-18"
output: html_document
---

### Libraries
```{r}
library(ggplot2)
library(readxl)
library(ggpubr)
library(paletteer)
library(tidyverse)
library(sjPlot)
library(cowplot)
library(janitor)
library(phyloseq)
library(M3C)
library(vegan)
library(cowplot)
library(grid)
library(gridExtra)
```

### Comparison R^2 of different data types
```{r}
# tax data was pulled from dan_out/All_stats_randomForest and added to All_stats.csv
ml_stats <- read.csv("machine_learning/16S_EC/All_stats.csv")
ml_stats_RA <- filter(ml_stats, RA_total_GIBBs == "RA" | RA_total_GIBBs == "RA_GIBBs")

stat.test <- compare_means(r2_val ~ RA_total_GIBBs,
                           data = ml_stats_RA,
                           method = "wilcox.test",
                           p.adj='fdr', group.by = "myVar")

stat.test$Comparison <- paste0(stat.test$myVar, " - ", stat.test$group1)
groups <- rcompanion::cldList(p.adj ~ Comparison,
                              data = stat.test,
                              threshold = 0.05)
groups$y <- 1
groups <- groups[1:13,]
groups$p.signif <- stat.test$p.signif

p1 <- ggplot(ml_stats_RA, aes(x=myVar, y=r2_val, fill = RA_total_GIBBs)) + 
  geom_boxplot() + 
  xlab("Indicator") +
  ylab(bquote(R^2~"Values")) +
  theme_bw() + 
  ylim(0,1) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_fill_discrete(name = "Data Type", labels = c("RA", "RA GIBBs")) +
  scale_x_discrete(labels = c("ACE","Active C","Agg. Stab.","Fe","K","Mg","Mn","P",
                              "pH","Respiration","SOM","Water Capacity","Zn")) +
  geom_text(inherit.aes=F, data=groups, aes(x=Group, y=y, label=p.signif))
p1

ggsave("figures/ml_ec_r2_RA.png", unit = "in", width = 10, height = 5, dpi = 300, device = "pdf")
```

### PCOAs using tsne
### to do: calculate permanova between land use and climate zone, clean up legend labels
```{r}
P <- readRDS('machine_learning/EC_RA_corr/ml_EC_RA_corr.RDS')

gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')

data <- P %>%
  select(gibbs$EC)

meta <- P

tsne_out <- Rtsne::Rtsne(data, perplexity=15, max_iter=1000)
plot(tsne_out$Y)

p1 <- M3C::tsne(t(data), labels=FALSE, dotsize = 0, seed=1234, perplex=15) + theme_bw() +
  geom_point(aes(fill=meta$ClimateZ, shape=meta$Current_Land_Use), size=4) +
  scale_shape_manual(values=c(21,22,23,24)) +
  guides(size="none",
         fill = guide_legend(override.aes = list(size = 4, shape=21))) +
  labs(fill="ClimateZ", shape="Land Use", x="tSNE 1", y="tSNE 2")
p1
#ggsave(paste0("figures/All_GIBBs_RA_corr_tSNE.png"), device='png', dpi=600, height=4, width=6)
```

### Feature importance distributions of GIBBs models
# includes indicators in which comparisons between all enzymes and GIBBs enzymes were either NS or GIBBs had higher R2 vals
```{r}
gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')

myVars <- c('SOM', 'resp', 'agg_stab', 'water_cap', 'mg', 'mn', 'zn')

for (myVar in myVars) {
     filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_RA_corr_GIBBs/"), pattern = paste0(myVar,"_RA_corr_GIBBs_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)

  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
  varimps_full$Predictor <- gsub("EC_","EC:", varimps_full$Predictor)
  varimps_full$Predictor <- gsub("_","\\.", varimps_full$Predictor)

 gDF <- varimps_full %>%
    left_join(gibbs, by=c("Predictor"="EC")) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))

  # filter out poor indicators
  temp <- gDF %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(10, Var) 
  
  gDF <- gDF %>%
    filter(Predictor %in% temp$Predictor)
  
  colors <- c("Biocontrol" = "#1F77B4FF",
              "C cycling" = "#FF7F0EFF",
              "C/N cycling" = "#2CA02CFF",
              "N cycling" = "#D62728FF",
              "P cycling" = "#9467BDFF",
              "S cycling" = "#8C564BFF",
              "Stress" = "#E377C2FF",
              "Siderophore" = "#7F7F7FFF",
              "NA" = "white")
  
  means <- aggregate(VIP ~ Predictor, gDF, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot(alpha = 1, fatten = 1) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), 
          legend.position = "none") +
    labs(x="", y="", title = myVar)
  p
  assign(paste0(myVar,"_gibbs"),p)
    #ggsave(paste0("figures/varimps/", myVar, "_RA_corr_GIBBs_varimp.png"), device='png', dpi=600, height=8, width=8)
}

# create legend of all GIBBs colors to add to merged plot
p_legend <- ggplot(gibbs, aes(x = EC, fill = Category)) +
  scale_fill_manual(values = colors) +
  geom_boxplot()
p_legend
p_legend2 <- get_legend(p_legend)
p_legend3 <- as_ggplot(p_legend2)
p_legend3

p_gibbs_merged <- ggarrange(agg_stab_gibbs, mg_gibbs, mn_gibbs, resp_gibbs,
                            SOM_gibbs, water_cap_gibbs, zn_gibbs, p_legend3,
                            nrow = 2, ncol = 4)
p_gibbs_merged

annotate_figure(p_gibbs_merged, left = textGrob("Variable Importance", rot = 90, vjust = 1),
                bottom = textGrob("Model Predictors"))

# to do: 
# fix plot titles
# combine y axis labels
```

### Feature importance distributions of non-GIBBs models
# coloring by network modules with a correlation coefficient of 0.8
# label GIBBs for each indicator somehow - or decide if I should instead graph the module models for these indicators (next chunk)
```{r}
gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')
gibbs$EC <- gsub(":","_", gibbs$EC)
gibbs$EC <- gsub("\\.","_", gibbs$EC)

myVars <- c('ace', 'SOM', 'activeC', 'resp', 'agg_stab', 'water_cap', 'ph', 'p', 'k', 'mg', 'fe', 'mn', 'zn')

modules <- read.csv("scripts/16S_EC/res_node_table_0.8.csv")
colnames(modules)[1] <- "Predictor"

# models with all enzymes
for (myVar in myVars) {
    filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_RA_corr/"), pattern = paste0(myVar,"_RA_corr_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)

  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
  varimps_full$Predictor <- gsub("EC_","EC:", varimps_full$Predictor)
  varimps_full$Predictor <- gsub("_","\\.", varimps_full$Predictor)

  gDF <- varimps_full %>%
    left_join(gibbs, by=c("Predictor"="EC")) %>% 
    left_join(modules, by = join_by(Predictor)) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))
  
  gDF$module <- as.factor(gDF$module)

  # filter out poor indicators
  temp <- gDF %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(20, Var) 
  
  gDF <- gDF %>%
    filter(Predictor %in% temp$Predictor)
  
  colors <- paletteer_d(`"ggsci::category20_d3"`)
  # colors <- c("Biocontrol" = "#1F77B4FF", 
  #             "C cycling" = "#FF7F0EFF",
  #             "C/N cycling" = "#2CA02CFF",
  #             "N cycling" = "#D62728FF", 
  #             "P cycling" = "#9467BDFF", 
  #             "S cycling" = "#8C564BFF",
  #             "Stess" = "#E377C2FF",
  #             "Siderophore" = "#7F7F7FFF",
  #             "Other" = "white")
  
  means <- aggregate(VIP ~ Predictor, gDF, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=module)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot() + 
    geom_point(aes(fill=module), shape=21) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
    labs(x="", y="Variable Importance")
  p
    #ggsave(paste0("figures/varimps/", myVar, "_RA_corr_varimp_mod0.8.png"), device='png', dpi=600, height=6, width=8)
}
```

### Feature importance distributions of models run using 0.8 modules
### need to add GIBBs labels to this for each indicator somehow
```{r}
myVars <- c('ace', 'SOM', 'activeC', 'resp', 'agg_stab', 'water_cap', 'ph', 'p', 'k', 'mg', 'fe', 'mn', 'zn')

for (myVar in myVars) {
    filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_modules/"), pattern = paste0(myVar,"_modules_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)

  names(varimps_full) <- c('Predictor', 'VIP', 'Run')

  # filter out poor indicators
  temp <- varimps_full %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(20, Var) 
  
  gDF <- varimps_full %>%
    filter(Predictor %in% temp$Predictor) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))
  
  colors <- paletteer_d(`"ggsci::category20_d3"`)
  
  means <- aggregate(VIP ~ Predictor, gDF, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p <- ggplot(gDF, aes(x=Predictor, y=VIP)) +
    geom_boxplot() + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
    labs(x="", y="Module Importance")
  p
    ggsave(paste0("figures/varimps/", myVar, "_module_varimp.png"), device='png', dpi=600, height=6, width=8)
}
```

























