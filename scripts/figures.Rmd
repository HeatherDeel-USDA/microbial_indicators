---
title: "Machine Learning Graphing"
author: "Heather Deel"
date: "2023-09-18"
output: html_document
---

### Libraries
```{r}
library(ggplot2)
library(readxl)
library(ggpubr)
library(paletteer)
library(tidyverse)
library(sjPlot)
library(cowplot)
library(janitor)
library(phyloseq)
library(M3C)
library(vegan)
library(cowplot)
library(grid)
library(gridExtra)
library(pairwiseAdonis)
library(ggcorrplot)
```

### Comparison R^2 of different data types
#### if including figure with all data types in supplement, add code for that back (without significances because it's too busy)
```{r}
# tax data was pulled from dan_out/All_stats_randomForest and added to All_stats.csv
ml_stats <- read.csv("machine_learning/16S_EC/All_stats.csv")
ml_stats_RA <- filter(ml_stats, RA_total_GIBBs == "RA" | RA_total_GIBBs == "RA_GIBBs")

stat.test <- compare_means(r2_val ~ RA_total_GIBBs,
                           data = ml_stats_RA,
                           method = "wilcox.test",
                           p.adj='fdr', group.by = "myVar")

stat.test$Comparison <- paste0(stat.test$myVar, " - ", stat.test$group1)
groups <- rcompanion::cldList(p.adj ~ Comparison,
                              data = stat.test,
                              threshold = 0.05)
groups$y <- 1
groups <- groups[1:13,]
groups$p.signif <- stat.test$p.signif

p1 <- ggplot(ml_stats_RA, aes(x=myVar, y=r2_val, fill = RA_total_GIBBs)) + 
  geom_boxplot() + 
  xlab("Indicator") +
  ylab(bquote(R^2~"Values")) +
  theme_bw() + 
  ylim(0,1) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_fill_discrete(name = "Data Type", labels = c("RA", "RA GIBBs")) +
  scale_x_discrete(labels = c("ACE","Active C","Agg. Stab.","Fe","K","Mg","Mn","P",
                              "pH","Respiration","SOM","Water Capacity","Zn")) +
  geom_text(inherit.aes=F, data=groups, aes(x=Group, y=y, label=p.signif))
p1

ggsave("figures/ml_ec_r2_RA.png", unit = "in", width = 10, height = 5, dpi = 300, device = "pdf")
```

### PCOAs using tsne
### to do: calculate permanova between land use and climate zone, clean up legend labels
```{r}
P <- readRDS('machine_learning/EC_RA_corr/ml_EC_RA_corr.RDS')

gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')

data <- P %>%
  select(gibbs$EC)

meta <- P
meta <- meta[,c(1:2,2439:2587)]

p1 <- M3C::tsne(t(data), labels=FALSE, dotsize = 0, seed=1234, perplex=15) + theme_bw() +
  geom_point(aes(fill=meta$ClimateZ, shape=meta$Current_Land_Use), size=4) +
  scale_shape_manual(values=c(21,22,23,24), labels = c("Annual Cropland","Perennial Cropland","Rangeland")) +
  guides(size="none",
         fill = guide_legend(override.aes = list(size = 4, shape=21))) +
  labs(fill="Climate Zone", shape="Land Use", x="tSNE 1", y="tSNE 2")
p1
#ggsave(paste0("figures/All_GIBBs_RA_corr_tSNE.png"), device='png', dpi=600, height=4, width=6)

# permanova between land use and climate zone
permanova_land <- pairwise.adonis2(data ~ Current_Land_Use,
                                data = meta,
                                permutations = 9999)
# p-vals for all comparisons less than 0.05

permanova_climate <- pairwise.adonis2(data ~ ClimateZ,
                                data = meta,
                                permutations = 9999)
```

### Feature importance distributions of GIBBs models
# includes indicators in which comparisons between all enzymes and GIBBs enzymes were either NS or GIBBs had higher R2 vals
```{r}
gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')

myVars <- c('SOM', 'resp', 'agg_stab', 'water_cap', 'mg', 'mn', 'zn')

for (myVar in myVars) {
     filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_RA_corr_GIBBs/"), pattern = paste0(myVar,"_RA_corr_GIBBs_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)
  
  # # changing myVar format for cleaner plot titles
  # move this to lower
  # if (myVar == 'resp'){
  #   myVar <- "Resp"
  # }
  # if (myVar == 'agg_stab'){
  #   myVar <- "AggStab"
  # }
  # if (myVar == 'water_cap'){
  #   myVar <- "WaterCap"
  # }
  # if (myVar == 'mg'){
  #   myVar <- "Mg"
  # }
  # if (myVar == 'mn'){
  #   myVar <- "Mn"
  # }
  # if (myVar == 'zn'){
  #   myVar <- "Zn"
  # }
  
  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
  varimps_full$Predictor <- gsub("EC_","EC:", varimps_full$Predictor)
  varimps_full$Predictor <- gsub("_","\\.", varimps_full$Predictor)

 gDF <- varimps_full %>%
    left_join(gibbs, by=c("Predictor"="EC")) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))
 
 # calculate positive and negative correlations between enzymes and indicators
 ml_EC_RA_corr <- readRDS('machine_learning/EC_RA_corr/ml_EC_RA_corr.RDS')
 
 ml_indic <- ml_EC_RA_corr %>% 
   select(gDF$Predictor, paste0(myVar,".bt")) %>% 
   subset(select=-c(ClimateZ, clay, DNA))
 
 ec.mat <- cor_pmat(ml_indic)
 ec.mat <- ec.mat %>% 
   subset(select = paste0(myVar,".bt"))
 ec.mat <- data.frame(ec.mat)
 ec.mat <- rownames_to_column(ec.mat, var = "Predictor")

 ec.mat.pos <- filter(ec.mat, paste0(myVar,".bt") > 0)
 ec.mat.neg <- filter(ec.mat, paste0(myVar,".bt") < 0)

  # filter out poor indicators (add code for doing this separately for pos and neg correlations)
 gDF.pos <- gDF %>% 
   filter(Predictor %in% ec.mat.pos$Predictor) # this leaves out clay, climate, DNA
 
 
  temp.pos <- gDF %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(10, Var) 
  temp.neg
  
  gDF <- gDF %>%
    filter(Predictor %in% temp$Predictor)
  
  colors <- c("Biocontrol" = "#1F77B4FF",
              "C cycling" = "#FF7F0EFF",
              "C/N cycling" = "#2CA02CFF",
              "N cycling" = "#D62728FF",
              "P cycling" = "#9467BDFF",
              "S cycling" = "#8C564BFF",
              "Stress" = "#E377C2FF",
              "Siderophore" = "#7F7F7FFF",
              "NA" = "white")
  
  means <- aggregate(VIP ~ Predictor, gDF, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot(alpha = 1, fatten = 1) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), 
          legend.position = "none", plot.title = element_text(size = 12)) +
    labs(x="", y="", title = myVar)
  p
  assign(paste0(myVar,"_gibbs"),p)
    #ggsave(paste0("figures/varimps/", myVar, "_RA_corr_GIBBs_varimp.png"), device='png', dpi=600, height=8, width=8)
}




# create legend of all GIBBs colors to add to merged plot
p_legend <- ggplot(gibbs, aes(x = EC, fill = Category)) +
  scale_fill_manual(values = colors) +
  geom_boxplot()
p_legend
p_legend2 <- get_legend(p_legend)
p_legend3 <- as_ggplot(p_legend2)
p_legend3

p_gibbs_merged <- ggarrange(AggStab_gibbs, Mg_gibbs, Mn_gibbs, Resp_gibbs,
                            SOM_gibbs, WaterCap_gibbs, Zn_gibbs, p_legend3,
                            nrow = 2, ncol = 4)
p_gibbs_merged

annotate_figure(p_gibbs_merged, left = text_grob("Variable Importance", rot = 90, vjust = 1, size = 14),
                bottom = text_grob("Model Predictors", size = 14))

#ggsave("figures/gibbs_varimps.png", device='png', dpi=600, height=8, width=12)
```

### Feature importance distributions of models run using 0.8 modules
# Using indicators where models with all enzymes performed better
```{r}
# import gibbs
gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')

# import modules
modules <- read.csv("scripts/16S_EC/res_node_table_0.8.csv")
modules <- modules[,2:12]
colnames(modules)[1] <- "EC"

# assign gibbs ECs modules
gibbs_mods <- gibbs %>% 
  left_join(modules, by = "EC") %>% 
  drop_na(module)
gibbs_mods$module <- gsub("M","MOD", gibbs_mods$module)
gibbs_mods$gibbs <- "G"
gibbs_mods <- gibbs_mods[,c(14,19)]
colnames(gibbs_mods)[1] <- "Predictor"

myVars <- c('ace', 'activeC', 'ph', 'p', 'k','fe')

for (myVar in myVars) {
    filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_modules/"), pattern = paste0(myVar,"_modules_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)
  
  # changing myVar format for cleaner plot titles
  if (myVar == 'ace'){
    myVar <- "ACE"
  }
  if (myVar == 'activeC'){
    myVar <- "ActiveC"
  }
  if (myVar == 'ph'){
    myVar <- "pH"
  }
  if (myVar == 'p'){
    myVar <- "P"
  }
  if (myVar == 'k'){
    myVar <- "K"
  }
  if (myVar == 'fe'){
    myVar <- "Fe"
  }

  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
  
  # left join with gibbs mods
  varimps_full_gibbs <- varimps_full %>% 
    left_join(gibbs_mods, by = "Predictor") 
  
  varimps_full_gibbs$gibbs <- varimps_full_gibbs$gibbs %>% 
   replace_na("NG")
  
  # filter out poor indicators
  temp <- varimps_full_gibbs %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(10, Var) 
  
  gDF <- varimps_full_gibbs %>%
    filter(Predictor %in% temp$Predictor) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))
  
  colors <- paletteer_d(`"ggsci::category20_d3"`)
  
  means <- aggregate(VIP ~ Predictor, gDF, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  
  # formatting for gibbs label
  if (myVar == 'ACE'){
    gDF$y <- 0.5
  }
  
  if (myVar == 'ActiveC'){
    gDF$y <- 0.35
  }
  
  if (myVar == 'pH'){
    gDF$y <- 0.35
  }
  
  if (myVar == 'P'){
    gDF$y <- 0.35
  }
  
  if (myVar == 'K'){
    gDF$y <- 0.62
  }
  
  if (myVar == 'Fe'){
    gDF$y <- 0.52
  }
  
  p <- ggplot(gDF, aes(x=Predictor, y=VIP)) +
    #scale_fill_manual(values=colors, na.value="white") + # maybe use this to fill GIBBs enzymes?
    geom_boxplot(alpha = 1, fatten = 1) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), plot.title = element_text(size = 12)) + 
    labs(x="", y="", title = myVar) +
    geom_text(inherit.aes=F, data=gDF, aes(x=Predictor, y=y, label=gibbs), size = 4)
  p
  assign(paste0(myVar,"_mods"),p)
  #ggsave(paste0("figures/varimps/", myVar, "_module_varimp.png"), device='png', dpi=600, height=6, width=8)
}

p_mods_merged <- ggarrange(ACE_mods, ActiveC_mods, Fe_mods, K_mods, P_mods, pH_mods,
                            nrow = 2, ncol = 3)
p_mods_merged

annotate_figure(p_mods_merged, left = text_grob("Variable Importance", rot = 90, vjust = 1, size = 14),
                bottom = text_grob("Model Predictors", size = 14))

ggsave("figures/mods_varimps.png", device='png', dpi=600, height=8, width=12)
```

### Feature importance distributions of indicators with better all enzyme models
# Not with modules since most were not collinear with GIBBs enzymes
```{r}
gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')

myVars <- c('ace', 'activeC', 'ph', 'p', 'k','fe')

for (myVar in myVars) {
     filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_RA_corr/"), pattern = paste0(myVar,"_RA_corr_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)
  
  # changing myVar format for cleaner plot titles
  if (myVar == 'ace'){
    myVar <- "ACE"
  }
  if (myVar == 'activeC'){
    myVar <- "ActiveC"
  }
  if (myVar == 'ph'){
    myVar <- "pH"
  }
  if (myVar == 'p'){
    myVar <- "P"
  }
  if (myVar == 'k'){
    myVar <- "K"
  }
  if (myVar == 'fe'){
    myVar <- "Fe"
  }
  
  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
  varimps_full$Predictor <- gsub("EC_","EC:", varimps_full$Predictor)
  varimps_full$Predictor <- gsub("_","\\.", varimps_full$Predictor)

 gDF <- varimps_full %>%
    left_join(gibbs, by=c("Predictor"="EC")) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))

  # filter out poor indicators
  temp <- gDF %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(10, Var) 
  
  gDF <- gDF %>%
    filter(Predictor %in% temp$Predictor)
  
  colors <- c("Biocontrol" = "#1F77B4FF",
              "C cycling" = "#FF7F0EFF",
              "C/N cycling" = "#2CA02CFF",
              "N cycling" = "#D62728FF",
              "P cycling" = "#9467BDFF",
              "S cycling" = "#8C564BFF",
              "Stress" = "#E377C2FF",
              "Siderophore" = "#7F7F7FFF",
              "NA" = "white")
  
  means <- aggregate(VIP ~ Predictor, gDF, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot(alpha = 1, fatten = 1) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), 
          legend.position = "none", plot.title = element_text(size = 12)) +
    labs(x="", y="", title = myVar)
  p
  assign(paste0(myVar,"_vars"),p)
    ggsave(paste0("figures/varimps/", myVar, "_RA_corr_varimp.png"), device='png', dpi=600, height=8, width=8)
}

# create legend of all GIBBs colors to add to merged plot
p_legend <- ggplot(gibbs, aes(x = EC, fill = Category)) +
  scale_fill_manual(values = colors) +
  geom_boxplot()
p_legend
p_legend2 <- get_legend(p_legend)
p_legend3 <- as_ggplot(p_legend2)
p_legend3

p_merged <- ggarrange(ACE_vars, ActiveC_vars, Fe_vars, K_vars,
                            P_vars, pH_vars, p_legend3,
                            nrow = 2, ncol = 4)
p_merged

annotate_figure(p_merged, left = text_grob("Variable Importance", rot = 90, vjust = 1, size = 14),
                bottom = text_grob("Model Predictors", size = 14))

ggsave("figures/all_enzyme_varimps.png", device='png', dpi=600, height=8, width=12)
```







