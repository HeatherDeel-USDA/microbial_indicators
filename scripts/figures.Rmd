---
title: "Machine Learning Graphing"
author: "Heather Deel"
date: "2023-09-18"
output: html_document
---

### Libraries
```{r}
library(ggplot2)
library(readxl)
library(ggpubr)
library(paletteer)
library(tidyverse)
library(sjPlot)
library(cowplot)
library(janitor)
library(phyloseq)
library(M3C)
library(vegan)
```

### Comparison R^2 of different data types
```{r}
# tax data was pulled from dan_out/All_stats_randomForest and added to All_stats.csv
ml_stats <- read.csv("machine_learning/16S_EC/All_stats.csv")

p1 <- ggplot(ml_stats, aes(x=myVar, y=r2_val, fill = RA_total_GIBBs)) + 
  geom_boxplot() + 
  xlab("Indicator") +
  ylab(bquote(R^2~"Values")) +
  theme_bw() + 
  ylim(0,1) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_fill_discrete(name = "Data Type", labels = c("EC RA", "EC Total", "GIBBs RA",
                                                     "GIBBs Total", "Tax RA", "Tax Total")) +
  scale_x_discrete(labels = c("ACE","Active C","Agg. Stab.","Fe","K","Mg","Mn","P",
                              "pH","Respiration","SOM","Water Capacity","Zn"))
p1

#ggsave("figures/ml_ec_r2_all.pdf", unit = "in", width = 10, height = 5, dpi = 300, device = "pdf")
#ggsave("figures/ml_ec_r2_all.tiff", unit = "in", width = 10, height = 5, dpi = 300, device = "tiff")
```

### Boxplot of R^2 values for each indicator
# just relative abundance
```{r}
ml_stats_RA <- filter(ml_stats, RA_total_GIBBs == "RA")

p1 <- ggplot(ml_stats_RA, aes(x=myVar, y=r2_val)) + 
  geom_boxplot(fill = "#F8766D") + 
  xlab("Indicator") +
  ylab(bquote(R^2~"Values")) +
  theme_bw() + 
  ylim(0,1) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_x_discrete(labels = c("ACE","Active C","Agg. Stab.","Fe","K","Mg","Mn","P",
                              "pH","Respiration","SOM","Water Capacity","Zn"))
p1

#ggsave("figures/ml_ec_r2_RA.pdf", unit = "in", width = 10, height = 5, dpi = 300, device = "pdf")
#ggsave("figures/ml_ec_r2_RA.tiff", unit = "in", width = 10, height = 5, dpi = 300, device = "tiff")
```

### Feature importance distributions
```{r}
# using results from a correlation coefficient of 0.8
gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')
gibbs$EC <- gsub(":","_", gibbs$EC)
gibbs$EC <- gsub("\\.","_", gibbs$EC)

myVars <- c('ace', 'SOM', 'activeC', 'resp', 'agg_stab', 'water_cap', 'ph', 'p', 'k', 'mg', 'fe', 'mn', 'zn')

modules <- read.csv("scripts/16S_EC/res_node_table_0.8.csv")
colnames(modules)[1] <- "Predictor"

# models with all enzymes
for (myVar in myVars) {
    filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_RA_corr/"), pattern = paste0(myVar,"_RA_corr_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)

  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
  varimps_full$Predictor <- gsub("EC_","EC:", varimps_full$Predictor)
  varimps_full$Predictor <- gsub("_","\\.", varimps_full$Predictor)

  gDF <- varimps_full %>%
    left_join(gibbs, by=c("Predictor"="EC")) %>% 
    left_join(modules, by = join_by(Predictor)) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))
  
  gDF$module <- as.factor(gDF$module)

  # filter out poor indicators
  temp <- gDF %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(20, Var) 
  
  gDF <- gDF %>%
    filter(Predictor %in% temp$Predictor)
  
  colors <- paletteer_d(`"ggsci::category20_d3"`)
  # colors <- c("Biocontrol" = "#1F77B4FF", 
  #             "C cycling" = "#FF7F0EFF",
  #             "C/N cycling" = "#2CA02CFF",
  #             "N cycling" = "#D62728FF", 
  #             "P cycling" = "#9467BDFF", 
  #             "S cycling" = "#8C564BFF",
  #             "Stess" = "#E377C2FF",
  #             "Siderophore" = "#7F7F7FFF",
  #             "Other" = "white")
  
  means <- aggregate(VIP ~ Predictor, gDF, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=module)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot() + 
    geom_point(aes(fill=module), shape=21) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
    labs(x="", y="Variable Importance")
  p
    #ggsave(paste0("figures/varimps/", myVar, "_RA_corr_varimp_mod0.8.png"), device='png', dpi=600, height=6, width=8)
}

# models with GIBBs enzymes
for (myVar in myVars) {
     filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_RA_corr_GIBBs/"), pattern = paste0(myVar,"_RA_corr_GIBBs_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)

  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
  varimps_full$Predictor <- gsub("EC_","EC:", varimps_full$Predictor)
  varimps_full$Predictor <- gsub("_","\\.", varimps_full$Predictor)

 gDF <- varimps_full %>%
    left_join(gibbs, by=c("Predictor"="EC")) %>% 
    left_join(modules, by = join_by(Predictor)) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))
  
  gDF$module <- as.factor(gDF$module)

  # filter out poor indicators
  temp <- gDF %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(20, Var) 
  
  gDF <- gDF %>%
    filter(Predictor %in% temp$Predictor)
  
  colors <- paletteer_d(`"ggsci::category20_d3"`)
  # colors <- c("Biocontrol" = "#1F77B4FF", 
  #             "C cycling" = "#FF7F0EFF",
  #             "C/N cycling" = "#2CA02CFF",
  #             "N cycling" = "#D62728FF", 
  #             "P cycling" = "#9467BDFF", 
  #             "S cycling" = "#8C564BFF",
  #             "Stess" = "#E377C2FF",
  #             "Siderophore" = "#7F7F7FFF",
  #             "Other" = "white")
  
  means <- aggregate(VIP ~ Predictor, gDF, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=module)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot() + 
    geom_point(aes(fill=module), shape=21) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
    labs(x="", y="Variable Importance")
  p
    #ggsave(paste0("figures/varimps/", myVar, "_RA_corr_GIBBs_varimp_mod0.8.png"), device='png', dpi=600, height=6, width=8)
}
```

### Relative abundance of ECs by subclasses and subsubclasses
```{r}
ECs <- read.csv("machine_learning/EC_RA_corr/ml_EC_RA_corr.csv", check.names = FALSE)

ECs2 <- ECs[,4:2439]
ECs2_t <- t(ECs2)
ECs2_t <- data.frame(ECs2_t)
ECs2_t <- rownames_to_column(ECs2_t, var = "ECs")

# collapse EC list to subclasses
pattern <- "EC:(.*)\\.(.*)\\."
ECs2_t$ECs_subclass <- regmatches(ECs2_t$ECs, regexec(pattern, ECs2_t$ECs))
ECs2_t$ECs_subclass2 <- sapply(ECs2_t$ECs_subclass, "[[", 2)
ECs2_sc <- ECs2_t[,c(2:537,539)]
ECs2_sc <- ECs2_sc %>% 
  group_by(ECs_subclass2) %>% 
  summarise_all(., .funs = sum)
  
# add EC: back as prefix
ECs2_sc$ECs_subclass2 <- paste0("EC:", ECs2_sc$ECs_subclass2)

# format "otu" table for importing into phyloseq
ECs2_sc <- column_to_rownames(ECs2_sc, var = "ECs_subclass2")

# attach sample names to column names
sample_names <- ECs$SampleID
colnames(ECs2_sc) <- sample_names

OTU = otu_table(ECs2_sc, taxa_are_rows = TRUE)

# format sample data for importing into phyloseq
EC_sam <- ECs[,c(2:3,2440:2588)]
EC_sam <- column_to_rownames(EC_sam, var = "SampleID")
EC_sam$SHMI2_bin <- factor(EC_sam$SHMI2_bin, levels = c("very low","low","medium","high","very high"))
EC_sam$SH_bin <- factor(EC_sam$SH_bin, levels = c("very low","low","medium","high","very high"))

SAM <- sample_data(EC_sam)

# use the EC description as "taxa"
EC_desc <- read_xlsx("ec_files_expasy/enzclass_R.xlsx")
EC_desc <- column_to_rownames(EC_desc, var = "EC")
EC_desc <- as.matrix(EC_desc)
TAX <- tax_table(EC_desc)

# create phyloseq object
p_subclass <- phyloseq(OTU, TAX, SAM)

# make SHMI bar chart
p_df <- psmelt(p_subclass)
ggplot(p_df, aes(x = SHMI2_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "SHMI Bin") +
  scale_fill_discrete(name = "Subclass")
#ggsave("figures/EC_abund_SHMI_subclass.pdf", unit = "in", width = 6, height = 4, dpi = 300, device = "pdf")

# make SEMWISE bar chart
ggplot(p_df, aes(x = SH_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "SEMWISE Bin") +
  scale_fill_discrete(name = "Subclass")
#ggsave("figures/EC_abund_SEMWISE_subclass.pdf", unit = "in", width = 6, height = 4, dpi = 300, device = "pdf")

# graph each subclass on its own
# in p_df, create a column with just subclass and filter by that
p_df$subclass = substr(p_df$OTU, start = 4, stop = 4)
unique(p_df$subclass)

# create df for each subclass
# 1 = oxidoreductases
# 2 = transferases
# 3 = hydrolases
# 4 = lyases
# 5 = isomerases
# 6 = ligases

p_df_1 <- subset(p_df, subclass == "1")
p_df_2 <- subset(p_df, subclass == "2")
p_df_3 <- subset(p_df, subclass == "3")
p_df_4 <- subset(p_df, subclass == "4")
p_df_5 <- subset(p_df, subclass == "5")
p_df_6 <- subset(p_df, subclass == "6")

# SHMI bar charts for all levels, combine and save
p1 <- ggplot(p_df_1, aes(x = SHMI2_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Oxidoreductases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p2 <- ggplot(p_df_2, aes(x = SHMI2_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Transferases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p3 <- ggplot(p_df_3, aes(x = SHMI2_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Hydrolases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p4 <- ggplot(p_df_4, aes(x = SHMI2_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Lyases") +
  scale_fill_discrete(name = "Subclass") + 
  ylim(0,250)
p5 <- ggplot(p_df_5, aes(x = SHMI2_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Isomerases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p6 <- ggplot(p_df_6, aes(x = SHMI2_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Ligases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p_SHMI_all <- ggarrange(p1,p2,p3,p4,p5,p6,
                    nrow = 2, ncol = 3)
p_SHMI_all <- annotate_figure(p_SHMI_all, 
                              bottom = text_grob("SHMI Bin"),
                              left = text_grob("Abundance", rot = 90))
p_SHMI_all
#ggsave("figures/EC_abund_SHMI_subclass_split.pdf", unit = "in", width = 12, height = 8, dpi = 300, device = "pdf")

# SEMWISE bar charts for all levels, combine and save
p1 <- ggplot(p_df_1, aes(x = SH_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Oxidoreductases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p2 <- ggplot(p_df_2, aes(x = SH_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Transferases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p3 <- ggplot(p_df_3, aes(x = SH_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Hydrolases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p4 <- ggplot(p_df_4, aes(x = SH_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Lyases") +
  scale_fill_discrete(name = "Subclass") + 
  ylim(0,250)
p5 <- ggplot(p_df_5, aes(x = SH_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Isomerases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p6 <- ggplot(p_df_6, aes(x = SH_bin, y = Abundance, fill = Family)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "", title = "Ligases") +
  scale_fill_discrete(name = "Subclass") +
  ylim(0,250)
p_SEMWISE_all <- ggarrange(p1,p2,p3,p4,p5,p6,
                    nrow = 2, ncol = 3)
p_SEMWISE_all <- annotate_figure(p_SEMWISE_all, 
                              bottom = text_grob("SEMWISE Bin"),
                              left = text_grob("Abundance", rot = 90))
p_SEMWISE_all
#ggsave("figures/EC_abund_SEMWISE_subclass_split.pdf", unit = "in", width = 12, height = 8, dpi = 300, device = "pdf")

# subsubclass level
# collapse EC list to subclasses
pattern <- "EC:(.*)\\.(.*)\\.(.*)\\."
ECs2_t$ECs_subsubclass <- regmatches(ECs2_t$ECs, regexec(pattern, ECs2_t$ECs))
ECs2_t$ECs_subsubclass2 <- sapply(ECs2_t$ECs_subsubclass, "[[", 1)
ECs2_ssc <- ECs2_t[,c(2:537,541)]
ECs2_ssc$ECs_subsubclass2 = substr(ECs2_ssc$ECs_subsubclass2, 1, nchar(ECs2_ssc$ECs_subsubclass2)-1)
ECs2_ssc <- ECs2_ssc %>% 
  group_by(ECs_subsubclass2) %>% 
  summarise_all(., .funs = sum)

# format "otu" table for importing into phyloseq
ECs2_ssc <- column_to_rownames(ECs2_ssc, var = "ECs_subsubclass2")

# attach sample names to column names
sample_names <- ECs$SampleID
colnames(ECs2_ssc) <- sample_names

OTU = otu_table(ECs2_ssc, taxa_are_rows = TRUE)

# format sample data for importing into phyloseq
EC_sam <- ECs[,c(2:3,2440:2588)]
EC_sam <- column_to_rownames(EC_sam, var = "SampleID")
EC_sam$SHMI2_bin <- factor(EC_sam$SHMI2_bin, levels = c("very low","low","medium","high","very high"))
EC_sam$SH_bin <- factor(EC_sam$SH_bin, levels = c("very low","low","medium","high","very high"))

SAM <- sample_data(EC_sam)

# use the EC description as "taxa"
EC_desc <- read_xlsx("ec_files_expasy/enzclass_R.xlsx")
EC_desc <- column_to_rownames(EC_desc, var = "EC")
EC_desc <- as.matrix(EC_desc)
TAX <- tax_table(EC_desc)

# create phyloseq object
p_subsubclass <- phyloseq(OTU, TAX, SAM)

# make SHMI bar chart
p_df <- psmelt(p_subsubclass)
ggplot(p_df, aes(x = SHMI2_bin, y = Abundance, fill = Genus)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "SHMI Bin") +
  scale_fill_discrete(name = "Sub-subclass")
ggsave("figures/EC_abund_SHMI_subsubclass.pdf", unit = "in", width = 6, height = 4, dpi = 300, device = "pdf")

# make SEMWISE bar chart
ggplot(p_df, aes(x = SH_bin, y = Abundance, fill = Genus)) +
  geom_bar(stat = "summary", fun = "mean") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "SEMWISE Bin") +
  scale_fill_discrete(name = "Sub-subclass")
#ggsave("figures/EC_abund_SEMWISE_subsubclass.pdf", unit = "in", width = 6, height = 4, dpi = 300, device = "pdf")
```

### Graph relative abundance of modules
```{r}
# need to bring in module data, merge with relabund data
# use correlatoin coefficient of 0.8
```

### PCOAs using tsne
```{r}
P <- readRDS('machine_learning/EC_RA_corr/ml_EC_RA_corr.RDS')

gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')

data <- P %>%
  select(gibbs$EC)

meta <- P

#tsne_out <- Rtsne::Rtsne(data, perplexity=15, max_iter=1000)
#plot(tsne_out$Y)

p1 <- M3C::tsne(t(data), labels=FALSE, dotsize = 0, seed=1234, perplex=15) + theme_bw() +
  geom_point(aes(fill=meta$ClimateZ, shape=meta$Current_Land_Use), size=4) +
  scale_shape_manual(values=c(21,22,23,24)) +
  guides(size="none",
         fill = guide_legend(override.aes = list(size = 4, shape=21))) +
  labs(fill="ClimateZ", shape="Land Use", x="tSNE 1", y="tSNE 2")
p1
ggsave(paste0("figures/All_GIBBs_RA_corr_tSNE.png"), device='png', dpi=600, height=4, width=6)
```

### quick plot of climate by activeC
# and do a feature
```{r}
p <- ggplot(ml_EC_16S, aes(x = ClimateZ, y = activeC, fill = ClimateZ)) +
  geom_boxplot()
p

p <- ggplot(ml_EC_16S, aes(x = clay, y = activeC)) +
  geom_point() +
  geom_smooth()
p

p <- ggplot(ml_EC_16S, aes(x = `EC:1.10.9.1`, y = activeC)) +
  geom_point() +
  geom_smooth()
p

p <- ggplot(ml_EC_16S, aes(x = `EC:1.3.99.35`, y = activeC)) +
  geom_point() +
  geom_smooth()
p

p <- ggplot(ml_EC_16S, aes(x = `EC:3.1.1.81`, y = activeC)) +
  geom_point() +
  geom_smooth()
p

```





















