---
title: "Machine Learning Graphing"
author: "Heather Deel"
date: "2023-09-18"
output: html_document
---

### Libraries
### make sure to clean these up, get rid of ones I don't use
```{r}
library(ggplot2)
library(readxl)
library(ggpubr)
library(paletteer)
library(tidyverse)
library(sjPlot)
library(cowplot)
library(janitor)
library(phyloseq)
library(M3C)
library(vegan)
library(cowplot)
library(grid)
library(gridExtra)
library(pairwiseAdonis)
library(ggcorrplot)
library(Hmisc)
library(rlist)
library(pipeR)
library(RColorBrewer)
library(png)
library(gplots)
library(dplyr)
```

### Figure 1
# comparison of model observed vs predicted R^2 values
# need to rerun taxonomic models, with nutrient data
# then add to below plot
```{r}
# tax data was pulled from dan_out/All_stats_randomForest and added to All_stats.csv
ml_stats <- read.csv("machine_learning/16S_EC/All_stats.csv")
ml_stats2 <- filter(ml_stats, model_type == "RA" | model_type == "Total" | model_type == "RA_TAX")

#stat.test <- compare_means(r2_val ~ model_type,
#                           data = ml_stats2,
#                           method = "wilcox.test",
#                           p.adj='fdr', group.by = "myVar")

#stat.test$Comparison <- paste0(stat.test$myVar, " - ", stat.test$group1)
#groups <- rcompanion::cldList(p.adj ~ Comparison,
#                              data = stat.test,
#                              threshold = 0.05)
#groups$y <- 1
#groups <- groups[1:13,]
#groups$p.signif <- stat.test$p.signif

p1 <- ggplot(ml_stats2, aes(x=myVar, y=r2_val, fill = model_type)) + 
  geom_boxplot() + 
  xlab("Indicator") +
  ylab(bquote(R^2~"Values")) +
  theme_bw() + 
  ylim(0,1) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_fill_discrete(name = "Data Type", labels = c("RA EC", "RA TAX", "Total EC")) +
  scale_x_discrete(labels = c("ACE","Active C","Agg. Stab.","Fe","K","Mg","Mn","P",
                              "pH","Respiration","SOM","Water Capacity","Zn"))
  #geom_text(inherit.aes=F, data=groups, aes(x=Group, y=y, label=p.signif))
p1

#ggsave("figures/ml_r2.png", unit = "in", width = 10, height = 5, dpi = 300, device = "png")
```

### Figure 2
# functional redundancy in taxonomic models
# commented out sections only need to be run once
############ to do:
####### redo heatmaps with ggplot2 so I can merge
####### make color breaks consistent in the heatmaps

```{r}
### import important ECs
top_ECs <- read.csv("machine_learning/16S_EC/top_ECs.csv", header = FALSE)
colnames(top_ECs) <- c("EC","mean_VIP","indicator")
top_ECs$EC <- gsub("EC:", "EC.", top_ECs$EC) 
top_ECs_unique <- top_ECs %>% # create list without duplicates
  distinct(EC)

### import important taxa
# need to import varimps first
myVars <- c('SOM', 'resp', 'agg_stab', 'water_cap', 'mg', 'mn', 'zn', 'ace', 'activeC', 'ph', 'p', 'k','fe')

# for (myVar in myVars) {
#      filenames <- list.files(paste0("machine_learning/16S_TAX/",myVar,"_model_results_RA_TAX/"), pattern = paste0(myVar,"_RA_TAX_varimp*"), full.names = TRUE)
#   varimps <- lapply(filenames, read.csv, header = FALSE)
#   varimps_full <- varimps %>%
#     reduce(full_join)
# 
#  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
# 
#  gDF <- varimps_full %>%
#    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))
# 
#  gDF <- gDF %>%
#    filter(gDF$Predictor != "ClimateZ" & gDF$Predictor != "clay" & gDF$Predictor != "DNA")
# 
#  temp <- gDF %>% group_by(Predictor) %>%
#     summarise(Var = median(VIP)) %>%
#     top_n(10, Var)
# 
#   gDF <- gDF %>%
#     filter(Predictor %in% temp$Predictor)
# 
#   # write important variables to a csv file
#   gDF.grouped <- gDF %>%
#     group_by(Predictor) %>%
#     summarise(mean_VIP = mean(VIP)) %>%
#     mutate(indicator = myVar)
# 
#   write.table(gDF.grouped, "machine_learning/16S_TAX/top_TAX.csv", sep = ",",
#               append = TRUE, row.names = FALSE, col.names = FALSE)
# }

# create list without duplicates
top_TAX <- read.csv("machine_learning/16S_TAX/top_TAX.csv", header = FALSE)
colnames(top_TAX) <- c("species","mean_VIP","indicator")
top_TAX_unique <- top_TAX %>% 
  distinct(species)

### import picrust2 copy number data for each data set
## hops 2018
# hops2018 <- read_tsv("picrust2_files/Hops.2018/EC_predicted_and_nsti.tsv")
# hops2018$sequence <- gsub("OTU", "", hops2018$sequence)  # get rid of "OTU" in taxon column
# colnames(hops2018)[1] <- "OTU_ID"
# 
# # associate OTU IDs with species names
# hops2018_otuid <- read.delim("16S_dada2_output/Hops.2018.taxonomy.otuid.csv",
#                               sep = ",")
# 
# hops2018_otuid$OTU_ID <- as.character(hops2018_otuid$OTU_ID)
# hops2018_sp <- hops2018 %>%
#   left_join(hops2018_otuid, by = "OTU_ID")
# hops2018_sp <- hops2018_sp %>%
#   select(starts_with("EC.") | starts_with("species"))
# 
# # get rid of unclassified species
# hops2018_sp <- hops2018_sp[!hops2018_sp$species == "",]
# 
# # split taxonomy to get just species
# hops2018_sp2 <- separate_wider_delim(hops2018_sp, cols = species, delim = ";",
#                                      names = c("kingdom", "phylum", "class",
#                                                "order", "family", "genus",
#                                                "species"))
# 
# # filter to only species and replace spaces with _ and . with _
# # also format some specific species so they are identical to that in top_TAX_unique list (for filtering later)
# hops2018_sp3 <- hops2018_sp2 %>%
#   select(starts_with("EC.") | starts_with("species"))
# hops2018_sp3$species <- gsub(" ", "_", hops2018_sp3$species)
# hops2018_sp3$species <- gsub("\\.", "_", hops2018_sp3$species)
# hops2018_sp3$species <- gsub("Bacillus_sp__X1\\(2014\\)", "Bacillus_sp__X1_2014_", hops2018_sp3$species)
# hops2018_sp3$species <- gsub("Bacillus_sp__HBCD-sjtu", "Bacillus_sp__HBCD_sjtu", hops2018_sp3$species)
# hops2018_sp3$species <- gsub("Burkholderiales_bacterium_GJ-E10", "Burkholderiales_bacterium_GJ_E10", hops2018_sp3$species)
# hops2018_sp3$species <- gsub("Rhodoplanes_sp__Z2-YC6860", "Rhodoplanes_sp__Z2_YC6860", hops2018_sp3$species)
# 
# # filter by important ECs and important species
# hops2018_sp4 <- hops2018_sp3 %>% 
#   group_by(species) %>% 
#   summarise(across(everything(), mean))
# hops2018_sp4 <- column_to_rownames(hops2018_sp4, var = "species")
# hops2018_sp5 <- hops2018_sp4[,names(hops2018_sp4) %in% top_ECs_unique$EC]
# hops2018_sp5 <- rownames_to_column(hops2018_sp5, "species")
# hops2018_sp6 <- hops2018_sp5[hops2018_sp5$species %in% top_TAX_unique$species,]
# 
# # convert to long format for merging with other data sets
# hops2018_sp6_long <- hops2018_sp6 %>%
#   pivot_longer(names_to = "EC",
#                values_to = "ECs_per_species",
#                cols = starts_with("EC."))
# 
# ## hops ARS
# hopsARS <- read.delim("picrust2_files/Hops.ARS/EC_predicted_and_nsti.tsv.gz", sep = "\t")
# hopsARS$sequence <- gsub("OTU", "", hopsARS$sequence)
# colnames(hopsARS)[1] <- "OTU_ID"
# hopsARS_otuid <- read.delim("16S_dada2_output/Hops.ARS.taxonomy.otuid.csv",
#                               sep = ",")
# 
# hopsARS_otuid$OTU_ID <- as.character(hopsARS_otuid$OTU_ID)
# hopsARS_sp <- hopsARS %>%
#   left_join(hopsARS_otuid, by = "OTU_ID")
# hopsARS_sp <- hopsARS_sp %>%
#   select(starts_with("EC.") | starts_with("species"))
# hopsARS_sp <- hopsARS_sp[!hopsARS_sp$species == "",]
# hopsARS_sp2 <- separate_wider_delim(hopsARS_sp, cols = species, delim = ";",
#                                      names = c("kingdom", "phylum", "class",
#                                                "order", "family", "genus",
#                                                "species"))
# hopsARS_sp3 <- hopsARS_sp2 %>%
#   select(starts_with("EC.") | starts_with("species"))
# hopsARS_sp3$species <- gsub(" ", "_", hopsARS_sp3$species)
# hopsARS_sp3$species <- gsub("\\.", "_", hopsARS_sp3$species)
# hopsARS_sp3$species <- gsub("Bacillus_sp__X1\\(2014\\)", "Bacillus_sp__X1_2014_", hopsARS_sp3$species)
# hopsARS_sp3$species <- gsub("Bacillus_sp__HBCD-sjtu", "Bacillus_sp__HBCD_sjtu", hopsARS_sp3$species)
# hopsARS_sp3$species <- gsub("Burkholderiales_bacterium_GJ-E10", "Burkholderiales_bacterium_GJ_E10", hopsARS_sp3$species)
# hopsARS_sp3$species <- gsub("Rhodoplanes_sp__Z2-YC6860", "Rhodoplanes_sp__Z2_YC6860", hopsARS_sp3$species)
# hopsARS_sp4 <- hopsARS_sp3 %>% 
#   group_by(species) %>% 
#   summarise(across(everything(), mean))
# hopsARS_sp4 <- column_to_rownames(hopsARS_sp4, var = "species")
# hopsARS_sp5 <- hopsARS_sp4[,names(hopsARS_sp4) %in% top_ECs_unique$EC]
# hopsARS_sp5 <- rownames_to_column(hopsARS_sp5, "species")
# hopsARS_sp6 <- hopsARS_sp5[hopsARS_sp5$species %in% top_TAX_unique$species,]
# hopsARS_sp6_long <- hopsARS_sp6 %>%
#   pivot_longer(names_to = "EC",
#                values_to = "ECs_per_species",
#                cols = starts_with("EC."))
# 
# ## NRCS
# NRCS <- read.delim("picrust2_files/NRCS/EC_predicted_and_nsti.tsv.gz", sep = "\t")
# NRCS$sequence <- gsub("OTU", "", NRCS$sequence)
# colnames(NRCS)[1] <- "OTU_ID"
# NRCS_otuid <- read.delim("16S_dada2_output/NRCS.taxonomy.otuid.csv",
#                               sep = ",")
# 
# NRCS_otuid$OTU_ID <- as.character(NRCS_otuid$OTU_ID)
# NRCS_sp <- NRCS %>%
#   left_join(NRCS_otuid, by = "OTU_ID")
# NRCS_sp <- NRCS_sp %>%
#   select(starts_with("EC.") | starts_with("species"))
# NRCS_sp <- NRCS_sp[!NRCS_sp$species == "",]
# NRCS_sp2 <- separate_wider_delim(NRCS_sp, cols = species, delim = ";",
#                                      names = c("kingdom", "phylum", "class",
#                                                "order", "family", "genus",
#                                                "species"))
# NRCS_sp3 <- NRCS_sp2 %>%
#   select(starts_with("EC.") | starts_with("species"))
# NRCS_sp3$species <- gsub(" ", "_", NRCS_sp3$species)
# NRCS_sp3$species <- gsub("\\.", "_", NRCS_sp3$species)
# NRCS_sp3$species <- gsub("Bacillus_sp__X1\\(2014\\)", "Bacillus_sp__X1_2014_", NRCS_sp3$species)
# NRCS_sp3$species <- gsub("Bacillus_sp__HBCD-sjtu", "Bacillus_sp__HBCD_sjtu", NRCS_sp3$species)
# NRCS_sp3$species <- gsub("Burkholderiales_bacterium_GJ-E10", "Burkholderiales_bacterium_GJ_E10", NRCS_sp3$species)
# NRCS_sp3$species <- gsub("Rhodoplanes_sp__Z2-YC6860", "Rhodoplanes_sp__Z2_YC6860", NRCS_sp3$species)
# NRCS_sp4 <- NRCS_sp3 %>% 
#   group_by(species) %>% 
#   summarise(across(everything(), mean))
# NRCS_sp4 <- column_to_rownames(NRCS_sp4, var = "species")
# NRCS_sp5 <- NRCS_sp4[,names(NRCS_sp4) %in% top_ECs_unique$EC]
# NRCS_sp5 <- rownames_to_column(NRCS_sp5, "species")
# NRCS_sp6 <- NRCS_sp5[NRCS_sp5$species %in% top_TAX_unique$species,]
# NRCS_sp6_long <- NRCS_sp6 %>%
#   pivot_longer(names_to = "EC",
#                values_to = "ECs_per_species",
#                cols = starts_with("EC."))
# 
# ## rangeland
# rangeland <- read.delim("picrust2_files/Rangeland/EC_predicted_and_nsti.tsv.gz", sep = "\t")
# rangeland$sequence <- gsub("OTU", "", rangeland$sequence)  # get rid of "OTU" in taxon column
# colnames(rangeland)[1] <- "OTU_ID"
# rangeland_otuid <- read.delim("16S_dada2_output/Rangeland.taxonomy.otuid.csv",
#                               sep = ",")
# 
# rangeland_otuid$OTU_ID <- as.character(rangeland_otuid$OTU_ID)
# rangeland_sp <- rangeland %>%
#   left_join(rangeland_otuid, by = "OTU_ID")
# rangeland_sp <- rangeland_sp %>%
#   select(starts_with("EC.") | starts_with("species"))
# rangeland_sp <- rangeland_sp[!rangeland_sp$species == "",]
# rangeland_sp2 <- separate_wider_delim(rangeland_sp, cols = species, delim = ";",
#                                      names = c("kingdom", "phylum", "class",
#                                                "order", "family", "genus",
#                                                "species"))
# rangeland_sp3 <- rangeland_sp2 %>%
#   select(starts_with("EC.") | starts_with("species"))
# rangeland_sp3$species <- gsub(" ", "_", rangeland_sp3$species)
# rangeland_sp3$species <- gsub("\\.", "_", rangeland_sp3$species)
# rangeland_sp3$species <- gsub("Bacillus_sp__X1\\(2014\\)", "Bacillus_sp__X1_2014_", rangeland_sp3$species)
# rangeland_sp3$species <- gsub("Bacillus_sp__HBCD-sjtu", "Bacillus_sp__HBCD_sjtu", rangeland_sp3$species)
# rangeland_sp3$species <- gsub("Burkholderiales_bacterium_GJ-E10", "Burkholderiales_bacterium_GJ_E10", rangeland_sp3$species)
# rangeland_sp3$species <- gsub("Rhodoplanes_sp__Z2-YC6860", "Rhodoplanes_sp__Z2_YC6860", rangeland_sp3$species)
# rangeland_sp4 <- rangeland_sp3 %>% 
#   group_by(species) %>% 
#   summarise(across(everything(), mean))
# rangeland_sp4 <- column_to_rownames(rangeland_sp4, var = "species")
# rangeland_sp5 <- rangeland_sp4[,names(rangeland_sp4) %in% top_ECs_unique$EC]
# rangeland_sp5 <- rownames_to_column(rangeland_sp5, "species")
# rangeland_sp6 <- rangeland_sp5[rangeland_sp5$species %in% top_TAX_unique$species,]
# rangeland_sp6_long <- rangeland_sp6 %>%
#   pivot_longer(names_to = "EC",
#                values_to = "ECs_per_species",
#                cols = starts_with("EC."))
# 
# ### merge, get rid of duplicates, and save
# all_merged <- rbind(hops2018_sp6_long, hopsARS_sp6_long, NRCS_sp6_long, rangeland_sp6_long)
# all_merged_unique <- all_merged %>%
#   distinct()
# 
# # check that all_merged_unique includes all of the top species
# length(unique(all_merged_unique$species))
# length(top_TAX_unique$species)
# # both include 93 species
# 
# saveRDS(all_merged_unique, "picrust2_files/Imp_EC_copies_per_imp_species.RDS")
all_merged_unique <- readRDS("picrust2_files/Imp_EC_copies_per_imp_species.RDS")

# shorten length of Pseudarthrobacter_sp__NIBRBAC000502772 so the plots aren't so squished
# write in figure description somewhere that this was changed
all_merged_unique$species <- gsub("Pseudarthrobacter_sp__NIBRBAC000502772", "Pseudarthrobacter_sp", all_merged_unique$species)
top_TAX$species <- gsub("Pseudarthrobacter_sp__NIBRBAC000502772", "Pseudarthrobacter_sp", top_TAX$species)


### graphs

for (myVar in myVars) {
  top_ECs_indic <- top_ECs %>% # don't need to use unique list since it's per indicator (and I can keep mean_VIP)
    filter(indicator == myVar)
  top_TAX_indic <- top_TAX %>% 
    filter(indicator == myVar)

  # filter all_merged down to just top taxa for each indicator
  all_merged_imp <- all_merged_unique %>% 
    filter(species %in% top_TAX_indic$species) 

  # filter by ECs in top ECs list
  all_merged_imp2 <- all_merged_imp %>% 
    filter(EC %in% top_ECs_indic$EC)
  
  # calculate number of species each EC occurs in
  all_merged_imp3 <- all_merged_imp2 %>% 
    group_by(species, EC) %>%
    filter(row_number()==1) %>%
    ungroup() %>%
    group_by(EC) %>% 
   summarise(species_freq = n())
  
  # sort ECs based on importance
  all_merged_imp3 <- all_merged_imp3 %>% 
    left_join(top_ECs_indic, by = "EC")
  all_merged_imp3 <- all_merged_imp3[order(all_merged_imp3$mean_VIP, decreasing = TRUE),]
  all_merged_imp3$EC <- reorder(all_merged_imp3$EC, all_merged_imp3$mean_VIP)
  
    # changing myVar format for cleaner plot titles
  if (myVar == 'resp'){
    myVar <- "Resp"
  }
  if (myVar == 'agg_stab'){
    myVar <- "AggStab"
  }
  if (myVar == 'water_cap'){
    myVar <- "WaterCap"
  }
  if (myVar == 'mg'){
    myVar <- "Mg"
  }
  if (myVar == 'mn'){
    myVar <- "Mn"
  }
  if (myVar == 'zn'){
    myVar <- "Zn"
  }
  if (myVar == 'ace'){
    myVar <- "ACE"
  }
  if (myVar == 'activeC'){
    myVar <- "ActiveC"
  }
  if (myVar == 'ph'){
    myVar <- "pH"
  }
  if (myVar == 'p'){
    myVar <- "P"
  }
  if (myVar == 'k'){
    myVar <- "K"
  }
  if (myVar == 'fe'){
    myVar <- "Fe"
  }
  
  # make bar chart of number of species for each EC
  # ECs increase in importance from left to right
  # just counts the important species now. Do we want to measure the total number of enzymes in each species? Unsure
  p <- ggplot(all_merged_imp3, aes(x = EC, y = species_freq)) + 
    geom_bar(stat = "identity") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.6)) +
    labs(x = "", y = "", title = myVar)
  p
  ggsave(paste0("figures/species_per_enzyme/species_freq_per_ez_",myVar,".png"), device='png', dpi=600, height=4, width=6)
  assign(paste0("bar_",myVar),p)
  
  # reorder ECs by importance
  all_merged_imp4 <- all_merged_imp2 %>% 
    left_join(top_ECs_indic, by = "EC")
  all_merged_imp4 <- all_merged_imp4[order(all_merged_imp4$mean_VIP),]
  all_merged_imp4$EC <- reorder(all_merged_imp4$EC, all_merged_imp4$mean_VIP)
  
  # reorder species by importance
  all_merged_imp5 <- all_merged_imp4 %>% 
    left_join(top_TAX_indic, by = "species")
  colnames(all_merged_imp5)[4] <- "mean_VIP_EC"
  colnames(all_merged_imp5)[6] <- "mean_VIP_TAX"
  all_merged_imp5$species <- reorder(all_merged_imp5$species, all_merged_imp5$mean_VIP_TAX)
  
  # create heatmaps
  p2 <- ggplot(all_merged_imp5, aes(x = EC, y = species, fill = ECs_per_species)) +
    geom_tile() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 6),
          axis.text.y = element_text(size = 6),
          legend.text = element_text(size = 8)) +
    scale_fill_binned(low = "white", high = "red", limits = c(0,10),
                      breaks = c(0,1,2,3,4,5,6,7,8,9,10)) +
    labs(x = "", y = "", title = myVar, fill = "Enzyme Copies")
  ggsave(paste0("figures/species_per_enzyme/species_freq_per_ez_heatmap_",myVar,".png"), device='png', dpi=600, height=4, width=6)
  assign(paste0("heatmap_",myVar),p2)
}

# create merged plot of species per EC
p_bar_all <- ggarrange(bar_ACE, bar_ActiveC, bar_AggStab,bar_Fe, bar_K, bar_Mg, 
                         bar_Mn,bar_P, bar_pH, bar_Resp, bar_SOM,bar_WaterCap, 
                         bar_Zn, ncol = 4, nrow = 4)
p_bar_all

annotate_figure(p_bar_all, left = text_grob("Species Frequency", rot = 90, vjust = 1, size = 14),
                bottom = text_grob("Top Enzymes", size = 14))
ggsave("figures/species_per_enzyme/species_freq_per_ez.png", device='png', dpi=600, height=12, width=10)

# create merged plot of heatmaps
p_heatmap_all <- ggarrange(heatmap_ACE, heatmap_ActiveC, heatmap_AggStab,heatmap_Fe, heatmap_K, heatmap_Mg, 
                         heatmap_Mn,heatmap_P, heatmap_pH, heatmap_Resp, heatmap_SOM,heatmap_WaterCap, 
                         heatmap_Zn, ncol = 4, nrow = 4, common.legend = TRUE)
p_heatmap_all

annotate_figure(p_heatmap_all, left = text_grob("Top Species", rot = 90, vjust = 1, size = 14),
                bottom = text_grob("Top Enzymes", size = 14))
ggsave("figures/species_per_enzyme/ez_copies_per_species_heatmap.png", device='png', dpi=600, height=14, width=14)


```

### Figure 3
# PCOAs using tsne
# output EC and taxonomy statistics to a file 
```{r}
### EC data PCOA
########### need to redo this with all enzymes, not just gibbs
P <- readRDS('machine_learning/EC_RA_corr/ml_EC_RA_corr.RDS')

data <- P[,3:2438]

meta <- P
meta <- meta[,c(1:2,2439:2587)]

p1 <- M3C::tsne(t(data), labels=FALSE, dotsize = 0, seed=1234, perplex=15) + theme_bw() +
  geom_point(aes(fill=meta$ClimateZ, shape=meta$Current_Land_Use), size=4) +
  scale_shape_manual(values=c(21,22,23,24), labels = c("Annual Cropland","Perennial Cropland","Rangeland")) +
  guides(size="none",
         fill = guide_legend(override.aes = list(size = 4, shape=21))) +
  labs(fill="Climate Zone", shape="Land Use", x="tSNE 1", y="tSNE 2", title = "Enzyme Data")
p1
ggsave(paste0("figures/All_enzymes_RA_corr_tSNE.png"), device='png', dpi=600, height=4, width=6)

# permanova between land use and climate zone
permanova_land <- pairwise.adonis2(data ~ Current_Land_Use,
                                data = meta,
                                permutations = 9999)
# p-vals for all comparisons less than 0.05

permanova_climate <- pairwise.adonis2(data ~ ClimateZ,
                                data = meta,
                                permutations = 9999)
# p-vals for all comparisons less than 0.05

### taxa data PCOA
P <- readRDS('machine_learning/16S_TAX/ml_TAX_16S.RDS')

data <- P[,152:7614]

meta <- P
meta <- meta[,1:151]

p2 <- M3C::tsne(t(data), labels=FALSE, dotsize = 0, seed=1234, perplex=15) + theme_bw() +
  geom_point(aes(fill=meta$ClimateZ, shape=meta$Current_Land_Use), size=4) +
  scale_shape_manual(values=c(21,22,23,24), labels = c("Annual Cropland","Perennial Cropland","Rangeland")) +
  guides(size="none",
         fill = guide_legend(override.aes = list(size = 4, shape=21))) +
  labs(fill="Climate Zone", shape="Land Use", x="tSNE 1", y="tSNE 2", title = "Taxa Data")
p2
ggsave(paste0("figures/TAX_RA_tSNE.png"), device='png', dpi=600, height=4, width=6)

# permanova between land use and climate zone
permanova_land <- pairwise.adonis2(data ~ Current_Land_Use,
                                data = meta,
                                permutations = 9999)
# p-vals for all comparisons less than 0.05

permanova_climate <- pairwise.adonis2(data ~ ClimateZ,
                                data = meta,
                                permutations = 9999)
# p-vals for all comparisons less than 0.05

# can output permanova results to a file to compare how well enzyme data and taxa data distinguishes between land use and climate zones - compare R^2 and F statistics

p_pcoa <- ggarrange(p1, p2, common.legend = TRUE, nrow = 1, ncol = 2)
p_pcoa
ggsave(paste0("figures/EC_TAX_RA_tSNE.png"), device='png', dpi=600, height=4, width=8.2)
```

### Figure 4 and Figure 5
# Feature importance distributions of indicators with all enzyme models
# separating by positively (Figure 4) and negatively (Figure 5) correlated enzymes
```{r}
myVars <- c('SOM', 'resp', 'agg_stab', 'water_cap', 'mg', 'mn', 'zn', 'ace', 'activeC', 'ph', 'p', 'k','fe')

for (myVar in myVars) {
     filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_RA_corr/"), pattern = paste0(myVar,"_RA_corr_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)
  
  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
  varimps_full$Predictor <- gsub("EC_","EC:", varimps_full$Predictor)
  varimps_full$Predictor <- gsub("_","\\.", varimps_full$Predictor)
  
  gibbs <- read.csv("picrust2_files/GIBBs.EC.numbers.csv", header = TRUE)

 gDF <- varimps_full %>%
    left_join(gibbs, by=c("Predictor"="EC")) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))

 # calculate positive and negative correlations between enzymes and indicators
 ml_EC_RA_corr <- readRDS('machine_learning/EC_RA_corr/ml_EC_RA_corr.RDS')
 
 # putting some indicators into their own loops since climateZ, clay, DNA not all found in them
 if (myVar == 'p') {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(DNA))
 }
 
 if (myVar == 'ph') {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(clay))
 }
 
 if (myVar == 'zn') {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(clay, DNA))
 }
 
 if (myVar == 'fe') {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(ClimateZ))
 }
 
 if (myVar %in% c('SOM', 'resp', 'agg_stab', 'water_cap', 'mg', 'mn', 'ace', 'activeC', 'k')) {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(ClimateZ, clay, DNA))
 }
 
 ml_indic <- as.matrix(ml_indic)
 ec.mat <- rcorr(ml_indic)
 ec.r <- ec.mat$r
 ec.indic <- ec.r %>% 
   subset(select = paste0(myVar))
 ec.indic <- data.frame(ec.indic)
 
 ############# format ec.indic and write most important ECs to a file
 ec.indic2 <- rownames_to_column(ec.indic, var = "Predictor")
 gDF2 <- gDF %>% 
   filter(Predictor %in% ec.indic2$Predictor)
 temp2 <- gDF2 %>% group_by(Predictor) %>%
   summarise(Var = median(VIP)) %>%
   top_n(10, Var)
 gDF2 <- gDF2 %>%
   filter(Predictor %in% temp2$Predictor)
   # write important variables to a csv file
 gDF2.grouped <- gDF2 %>% 
   group_by(Predictor) %>% 
   summarise(mean_VIP = mean(VIP)) %>% 
   mutate(indicator = myVar)

 write.table(gDF2.grouped, "machine_learning/16S_EC/top_ECs.csv", sep = ",",
              append = TRUE, row.names = FALSE, col.names = FALSE)

 # format ec.indic but separate by positive and negative correlation values
 ec.indic.pos <- ec.indic %>% 
   filter(ec.indic[,1] > 0)
 ec.indic.neg <- ec.indic %>% 
   filter(ec.indic[,1] < 0)
 ec.indic.pos <- rownames_to_column(ec.indic.pos, var = "Predictor")
 ec.indic.neg <- rownames_to_column(ec.indic.neg, var = "Predictor")
 ec.indic.pos <- ec.indic.pos[ec.indic.pos$Predictor != myVar,]
 ec.indic.neg <- ec.indic.neg[ec.indic.neg$Predictor != myVar,]

  # filter out poor indicators in pos and neg correlations
  # add this if I want to include climate, clay, and DNA:
  # | Predictor %in% c('clay','ClimateZ','DNA')
 gDF.pos <- gDF %>% 
   filter(Predictor %in% ec.indic.pos$Predictor) 
 gDF.neg <- gDF %>% 
   filter(Predictor %in% ec.indic.neg$Predictor) 
 
  temp.pos <- gDF.pos %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(10, Var) 
  temp.neg <- gDF.neg %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(10, Var) 
  
  gDF.pos <- gDF.pos %>%
    filter(Predictor %in% temp.pos$Predictor)
  gDF.neg <- gDF.neg %>%
    filter(Predictor %in% temp.neg$Predictor)
  
  colors <- c("Biocontrol" = "#1F77B4FF",
              "C cycling" = "#FF7F0EFF",
              "C/N cycling" = "#2CA02CFF",
              "N cycling" = "#D62728FF",
              "P cycling" = "#9467BDFF",
              "S cycling" = "#8C564BFF",
              "Stress" = "#E377C2FF",
              "Siderophore" = "#7F7F7FFF",
              "NA" = "white")
  
  # changing myVar format for cleaner plot titles
  if (myVar == 'resp'){
    myVar <- "Resp"
  }
  if (myVar == 'agg_stab'){
    myVar <- "AggStab"
  }
  if (myVar == 'water_cap'){
    myVar <- "WaterCap"
  }
  if (myVar == 'mg'){
    myVar <- "Mg"
  }
  if (myVar == 'mn'){
    myVar <- "Mn"
  }
  if (myVar == 'zn'){
    myVar <- "Zn"
  }
  if (myVar == 'ace'){
    myVar <- "ACE"
  }
  if (myVar == 'activeC'){
    myVar <- "ActiveC"
  }
  if (myVar == 'ph'){
    myVar <- "pH"
  }
  if (myVar == 'p'){
    myVar <- "P"
  }
  if (myVar == 'k'){
    myVar <- "K"
  }
  if (myVar == 'fe'){
    myVar <- "Fe"
  }
  # positive correlation graph
  means <- aggregate(VIP ~ Predictor, gDF.pos, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p.pos <- ggplot(gDF.pos, aes(x=Predictor, y=VIP, fill=Category)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot(alpha = 1, fatten = 1) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), 
          legend.position = "none", plot.title = element_text(size = 12)) +
    labs(x="", y="", title = myVar)
  p.pos
  #assign(paste0(myVar,"_pos"),p.pos)
    #ggsave(paste0("figures/varimps/", myVar, "_RA_corr_varimp.pos.png"), device='png', dpi=600, height=8, width=8)
  
  # negative correlation graph
  means <- aggregate(VIP ~ Predictor, gDF.neg, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p.neg <- ggplot(gDF.neg, aes(x=Predictor, y=VIP, fill=Category)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot(alpha = 1, fatten = 1) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), 
          legend.position = "none", plot.title = element_text(size = 12)) +
    labs(x="", y="", title = myVar)
  p.neg
  #assign(paste0(myVar,"_neg"),p.neg)
    #ggsave(paste0("figures/varimps/", myVar, "_RA_corr_varimp.neg.png"), device='png', dpi=600, height=8, width=8)
}

# create legend of all GIBBs colors to add to merged plot
p_legend <- ggplot(gibbs, aes(x = EC, fill = Category)) +
  scale_fill_manual(values = colors) +
  geom_boxplot()
p_legend
p_legend2 <- get_legend(p_legend)
p_legend3 <- as_ggplot(p_legend2)
p_legend3

# positive correlations graph
p_merged_pos <- ggarrange(ACE_pos, ActiveC_pos, AggStab_pos, 
                                Fe_pos, K_pos, Mg_pos, Mn_pos, 
                                P_pos, pH_pos, Resp_pos, 
                                SOM_pos, WaterCap_pos, Zn_pos,
                                p_legend3, nrow = 2, ncol = 7)
p_merged_pos

annotate_figure(p_merged_pos, left = text_grob("Variable Importance", rot = 90, vjust = 1, size = 14),
                bottom = text_grob("Positively Correlated Model Predictors", size = 14),
                top = text_grob("All Enzymes", size = 14))

#ggsave("figures/all_enzyme_varimps_pos.png", device='png', dpi=600, height=6, width=12)

# negative correlations graph
p_merged_neg <- ggarrange(ACE_neg, ActiveC_neg, AggStab_neg, 
                                Fe_neg, K_neg, Mg_neg, Mn_neg, 
                                P_neg, pH_neg, Resp_neg, 
                                SOM_neg, WaterCap_neg, Zn_neg,
                                p_legend3, nrow = 2, ncol = 7)
p_merged_neg

annotate_figure(p_merged_neg, left = text_grob("Variable Importance", rot = 90, vjust = 1, size = 14),
                bottom = text_grob("Negatively Correlated Model Predictors", size = 14),
                top = text_grob("All Enzymes", size = 14))

#ggsave("figures/all_enzyme_varimps_neg.png", device='png', dpi=600, height=6, width=12)
```







