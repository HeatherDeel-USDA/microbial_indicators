---
title: "Machine Learning Graphing"
author: "Heather Deel"
date: "2023-09-18"
output: html_document
---

### Libraries
```{r}
library(ggplot2)
library(readxl)
library(ggpubr)
library(paletteer)
library(tidyverse)
library(sjPlot)
library(cowplot)
library(janitor)
library(phyloseq)
```

### Comparison R^2 of different data types
```{r}
# tax data was pulled from dan_out/All_stats_randomForest and added to All_stats.csv
ml_stats <- read.csv("machine_learning/16S_EC/All_stats.csv")

p1 <- ggplot(ml_stats, aes(x=myVar, y=r2_val, fill = RA_total)) + 
  geom_boxplot() + 
  xlab("Indicator") +
  ylab(bquote(R^2~"Values")) +
  theme_bw() + 
  ylim(0,1) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_fill_discrete(name = "Data Type", labels = c("EC RA", "EC Total", "GIBBs RA",
                                                     "GIBBs Total", "Tax RA", "Tax Total")) +
  scale_x_discrete(labels = c("ACE","Active C","Agg. Stab.","Fe","K","Mg","Mn","P",
                              "pH","Respiration","SOM","Water Capacity","Zn"))
p1

ggsave("figures/ml_ec_r2_all.pdf", unit = "in", width = 10, height = 5, dpi = 300, device = "pdf")
ggsave("figures/ml_ec_r2_all.tiff", unit = "in", width = 10, height = 5, dpi = 300, device = "tiff")
```

### Boxplot of R^2 values for each indicator
# just relative abundance
```{r}
ml_stats_RA <- filter(ml_stats, RA_total == "EC_RA")

p1 <- ggplot(ml_stats_RA, aes(x=myVar, y=r2_val)) + 
  geom_boxplot(fill = "#F8766D") + 
  xlab("Indicator") +
  ylab(bquote(R^2~"Values")) +
  theme_bw() + 
  ylim(0,1) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_x_discrete(labels = c("ACE","Active C","Agg. Stab.","Fe","K","Mg","Mn","P",
                              "pH","Respiration","SOM","Water Capacity","Zn"))
p1

ggsave("figures/ml_ec_r2_RA.pdf", unit = "in", width = 10, height = 5, dpi = 300, device = "pdf")
ggsave("figures/ml_ec_r2_RA.tiff", unit = "in", width = 10, height = 5, dpi = 300, device = "tiff")
```

### Feature importance distributions
```{r}
gibbs <- read.csv('picrust2_files/GIBBs.EC.numbers.csv')
gibbs <- gibbs %>%
  filter(Missing != 'x')
gibbs$EC <- gsub(":","_", gibbs$EC)
gibbs$EC <- gsub("\\.","_", gibbs$EC)

myVars <- c('ace', 'SOM', 'activeC', 'resp', 'agg_stab', 'water_cap', 'ph', 'p', 'k', 'mg', 'fe', 'mn', 'zn')

myVar <- 'ace'

# models with all enzymes
for (myVar in myVars) {
  df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr/", myVar, "_RA_corr_varimp.csv"), header=FALSE)
  names(df) <- c('Predictor', 'VIP', 'Run')

  gDF <- df %>%
    left_join(gibbs, by=c("Predictor"="EC")) %>% 
    mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

  gDF <- gDF %>% group_by(Predictor) %>% 
    mutate(Var = mean(VIP)) %>%
    filter(Var > 0.01) %>% select(-Var) %>%   # filter out poor indicators
    mutate(VIP_scaled = scale(VIP)) %>% 
    mutate(all_gibbs = "all")
  
  write.table(cbind(gDF, myVar), file = "machine_learning/16S_EC/final_varimps.csv", 
              col.names = FALSE, row.names = FALSE, append = TRUE, sep = ",")

  colors <- paletteer_d(`"ggsci::category20_d3"`)

  p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot() + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90)) +
    labs(x="", y="Variable Importance", title = myVar)
  p
  ggsave(paste0("figures/varimps/", myVar, "_varimp.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")
}

# models with GIBBs enzymes
for (myVar in myVars) {
  df <- read.csv(paste0("machine_learning/16S_EC/", myVar, "_model_results_RA_corr_GIBBs/", myVar, "_RA_corr_GIBBs_varimp.csv"), header=FALSE)
  names(df) <- c('Predictor', 'VIP', 'Run')

  gDF <- df %>%
    left_join(gibbs, by=c("Predictor"="EC")) %>% 
    mutate(Short=fct_reorder(Short, VIP, .fun=mean, .desc=TRUE)) # sort levels by mean VIP

  gDF <- gDF %>% group_by(Predictor) %>% 
    mutate(Var = mean(VIP)) %>%
    filter(Var > 0.01) %>% select(-Var) %>% # filter out poor indicators
    mutate(VIP_scaled = scale(VIP)) %>%  # scale VIP
    mutate(all_gibbs = "GIBBs")
  
  # write important features + myVar name to a file
  write.table(cbind(gDF, myVar), file = "machine_learning/16S_EC/final_varimps.csv", 
              col.names = FALSE, row.names = FALSE, append = TRUE, sep = ",")

  colors <- paletteer_d(`"ggsci::category20_d3"`)

  p <- ggplot(gDF, aes(x=Predictor, y=VIP, fill=Category)) +
    scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot() + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90)) +
    labs(x="", y="GIBBs Variable Importance", title = myVar)
  p
  ggsave(paste0("figures/varimps/", myVar, "_varimp_GIBBs.tiff"), unit = "in", width = 8, height = 6, dpi = 300, device = "tiff")
}
```

### Make varimp list of GIBBs + important features for each indicator
```{r}
varimp_df <- read.csv("machine_learning/16S_EC/final_varimps.csv", header = FALSE)

colnames(varimp_df) <- c("Predictor","VIP","Run","Category","Class","Sub_class",
                         "Name","Short","Book","Missing","VIP_scaled","all_gibbs",
                         "indicator")

myVars <- c('ace', 'SOM', 'activeC', 'resp', 'agg_stab', 'water_cap', 'ph', 'p', 'k', 'mg', 'fe', 'mn', 'zn')

for (myVar in myVars) {
  varimp_df_filt <- filter(varimp_df, indicator == myVar)
  varimp_df_list <- varimp_df_filt %>% 
    group_by(Predictor) %>% 
    summarize(VIP_scaled_avg = mean(VIP_scaled))
  write.csv(varimp_df_list, file = paste0("machine_learning/16S_FINAL/", myVar,"_EC_GIBBs_final.csv"),
            row.names = FALSE)
}
```

### Partial dependence plots of final models

########## things to do here:
# unscale indicators
# graph the climate z plots as a bar chart (but still need to unscale those) - try to add a for loop within the graphing section for this
```{r}
# show response of important features to each indicator
myVars <- c('ace', 'SOM', 'activeC', 'resp', 'agg_stab', 'water_cap', 'ph', 'p', 'k', 'mg', 'fe', 'mn', 'zn')

myVar <- 'ace'
# for now I just have to change myVar for each indicator and change the attributes colnames in 181-182 - can't figure out how to access the scaled:scaled and scaled:center in the loop

# read in data.pred so I can use the attributes to unscale the indicators
data.pred <- readRDS("metadata/data.pred.SHMI.RDS")

#for (myVar in myVars) {
  filenames <- list.files(paste0("machine_learning/16S_FINAL/",myVar,"_model_results/"), pattern = paste0(myVar,"_final_pd_Predictor*"), full.names = TRUE)
  predictors <- lapply(filenames, read.csv, header = FALSE)
  colnames <- c("predictor","predictor_value","indicator_response")
  predictors <- lapply(predictors, setNames, colnames)
  
  for (i in seq_along(predictors)) {
    predictors[[i]]$unscaled <- predictors[[i]]$indicator_response * attributes(data.pred$ace)['scaled:scale'][[1]] + attributes(data.pred$ace)['scaled:center'][[1]]
  }
  make_graphs <- function(x) {
    ggplot(x, aes(x = predictor_value, y = indicator_response, group = factor(predictor))) +
    geom_line() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.x = element_text(angle = 90)) +
    facet_wrap(~predictor)
  }
  make_bargraphs <- function(x) {
    ggplot(x, aes(x = predictor_value, y = indicator_response, group = factor(predictor))) +
    geom_bar() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.x = element_text(angle = 90)) +
    facet_wrap(~predictor)
  }
  for (i in seq_along(predictors)) {
    if (predictors[[i]]$predictor[1] == "ClimateZ") {
      p1 = lapply(predictors, make_bargraphs)
    }
    if (predictors[[i]]$predictor[1] != "ClimateZ") {
      p2 = lapply(predictors, make_graphs)
    }
  }
  p3 <- ggarrange(p1[[1]],p2[[1]],p2[[2]],p2[[3]],p2[[4]],
                  p2[[5]],p2[[6]],p2[[7]],p2[[8]],p2[[9]],
                  nrow = 2, ncol = 5)
  p3
  annotate_figure(p3, left = text_grob(myVar, rot = 90),
                  bottom = text_grob("Feature Value"))
  ggsave(paste0("figures/pdp/", myVar, "_pdp.png"), unit = "in", width = 10, height = 4, dpi = 300, device = "png")
#}
```

### Relative abundance of ECs by subclasses
# redo part of this section using the R way to collapse into sublevels and subsublevels - more reproducible
```{r}
### subclass level data
EC_subclass <- read.csv("machine_learning/EC_RA_corr/ml_EC_RA_corr_subclass.csv")

# not sure if I should recalculate relative abundances or not, since the EC data was already in RA (and then corrected by copy number)
# for now I won't redo RA and will just graph

# format "otu" table for importing into phyloseq
EC_subclass_t <- t(EC_subclass) %>% 
  row_to_names(row_number = 1)
EC_subclass_t <- as.matrix(EC_subclass_t)
EC_subclass_otu <- EC_subclass_t[63:123,]
EC_subclass_otu <- data.frame(EC_subclass_otu)

EC_subclass_otu_num <- lapply(EC_subclass_otu, as.numeric)
EC_subclass_otu_num <- data.frame(EC_subclass_otu_num)
rownames(EC_subclass_otu_num) <- rownames(EC_subclass_otu)

OTU = otu_table(EC_subclass_otu_num, taxa_are_rows = TRUE)

# format sample data for importing into phyloseq
EC_subclass_sam <- EC_subclass[,c(1:63,125:212)]
EC_subclass_sam <- column_to_rownames(EC_subclass_sam, var = "SampleID")
EC_subclass_sam$SHMI2_bin <- factor(EC_subclass_sam$SHMI2_bin, levels = c("very low","low","medium","high","very high"))
EC_subclass_sam$SH_bin <- factor(EC_subclass_sam$SH_bin, levels = c("very low","low","medium","high","very high"))

SAM <- sample_data(EC_subclass_sam)

# use the EC description as "taxa"
EC_desc <- read_xlsx("ec_files_expasy/enzclass_R.xlsx")
EC_desc <- column_to_rownames(EC_desc, var = "EC")
EC_desc <- as.matrix(EC_desc)
TAX <- tax_table(EC_desc)

# create phyloseq object
p_subclass <- phyloseq(OTU, TAX, SAM)

# make SHMI bar charts
plot_bar(p_subclass, x = "SHMI2_bin", fill = "Order") + 
  geom_bar(stat = "identity") +
  theme_classic() +
  labs(x = "SHMI Bin") +
  scale_fill_discrete(name = "Subclass")
ggsave("figures/EC_abund_SHMI_subclass.pdf", unit = "in", width = 6, height = 4, dpi = 300, device = "pdf")

# make SEMWISE bar charts
plot_bar(p_subclass, x = "SH_bin", fill = "Order") + # subclass
  geom_bar(stat = "identity") +
  theme_classic() +
  labs(x = "SEMWISE Bin") +
  scale_fill_discrete(name = "Subclass")
ggsave("figures/EC_abund_SEMWISE_subclass.pdf", unit = "in", width = 6, height = 4, dpi = 300, device = "pdf")

### subsubclass level data
# start from level 4 EC data and collapse to the subsubclass level in R
ECs <- read.csv("machine_learning/EC_RA_corr/ml_EC_RA_corr.csv", check.names = FALSE)

EC_subsubclass_list <- c("EC:1.1.1","EC:1.1.2","EC:1.1.3","EC:1.1.5","EC:1.1.9","EC:1.1.98","EC:1.1.99",
"EC:1.10.2","EC:1.10.3","EC:1.10.9","EC:1.11.1","EC:1.11.2","EC:1.12.1","EC:1.12.2",
"EC:1.12.5","EC:1.12.7","EC:1.12.98","EC:1.12.99","EC:1.13.11","EC:1.13.12","EC:1.13.99",
"EC:1.14.11","EC:1.14.12","EC:1.14.13","EC:1.14.14","EC:1.14.15","EC:1.14.16",
"EC:1.14.17","EC:1.14.18","EC:1.14.19","EC:1.14.21","EC:1.14.99","EC:1.15.1",
"EC:1.16.1","EC:1.16.3","EC:1.16.8","EC:1.17.1","EC:1.17.2","EC:1.17.3","EC:1.17.4",
"EC:1.17.5","EC:1.17.7","EC:1.17.99","EC:1.18.1","EC:1.18.6","EC:1.2.1","EC:1.2.3",
"EC:1.2.4","EC:1.2.5","EC:1.2.7","EC:1.2.98","EC:1.2.99","EC:1.20.1","EC:1.20.4",
"EC:1.20.9","EC:1.21.4","EC:1.21.98","EC:1.3.1","EC:1.3.3","EC:1.3.4","EC:1.3.5",
"EC:1.3.7","EC:1.3.8","EC:1.3.98","EC:1.3.99","EC:1.4.1","EC:1.4.3","EC:1.4.4",
"EC:1.4.7","EC:1.4.9","EC:1.4.99","EC:1.5.1","EC:1.5.3","EC:1.5.5","EC:1.5.8",
"EC:1.5.98","EC:1.5.99","EC:1.6.1","EC:1.6.2","EC:1.6.3","EC:1.6.5","EC:1.6.99",
"EC:1.7.1","EC:1.7.2","EC:1.7.3","EC:1.7.7","EC:1.7.99","EC:1.8.1","EC:1.8.2",
"EC:1.8.3","EC:1.8.4","EC:1.8.5","EC:1.8.7","EC:1.8.98","EC:1.8.99","EC:1.9.3",
"EC:1.97.1","EC:2.1.1","EC:2.1.2","EC:2.1.3","EC:2.1.4","EC:2.10.1","EC:2.2.1",
"EC:2.3.1","EC:2.3.2","EC:2.3.3","EC:2.4.1","EC:2.4.2","EC:2.4.99","EC:2.5.1",
"EC:2.6.1","EC:2.6.99","EC:2.7.1","EC:2.7.10","EC:2.7.11","EC:2.7.14","EC:2.7.2",
"EC:2.7.3","EC:2.7.4","EC:2.7.6","EC:2.7.7","EC:2.7.8","EC:2.7.9","EC:2.8.1",
"EC:2.8.2","EC:2.8.3","EC:2.8.4","EC:2.9.1","EC:3.1.1","EC:3.1.11","EC:3.1.12",
"EC:3.1.13","EC:3.1.2","EC:3.1.21","EC:3.1.22","EC:3.1.25","EC:3.1.26","EC:3.1.27",
"EC:3.1.3","EC:3.1.30","EC:3.1.31","EC:3.1.4","EC:3.1.5","EC:3.1.6","EC:3.1.7",
"EC:3.1.8","EC:3.10.1","EC:3.11.1","EC:3.13.1","EC:3.2.1","EC:3.2.2","EC:3.3.1",
"EC:3.3.2","EC:3.4.11","EC:3.4.13","EC:3.4.14","EC:3.4.15","EC:3.4.16","EC:3.4.17",
"EC:3.4.19","EC:3.4.21","EC:3.4.22","EC:3.4.23","EC:3.4.24","EC:3.4.25","EC:3.5.1",
"EC:3.5.2","EC:3.5.3","EC:3.5.4","EC:3.5.5","EC:3.5.99","EC:3.6.1","EC:3.6.3",
"EC:3.6.4","EC:3.7.1","EC:3.8.1","EC:4.1.1","EC:4.1.2","EC:4.1.3","EC:4.1.99",
"EC:4.2.1","EC:4.2.2","EC:4.2.3","EC:4.2.99","EC:4.3.1","EC:4.3.2","EC:4.3.3",
"EC:4.3.99","EC:4.4.1","EC:4.6.1","EC:4.7.1","EC:4.99.1","EC:5.1.1","EC:5.1.2",
"EC:5.1.3","EC:5.1.99","EC:5.2.1","EC:5.3.1","EC:5.3.2","EC:5.3.3","EC:5.3.4",
"EC:5.3.99","EC:5.4.1","EC:5.4.2","EC:5.4.3","EC:5.4.4","EC:5.4.99","EC:5.5.1",
"EC:5.99.1","EC:6.1.1","EC:6.1.2","EC:6.2.1","EC:6.3.1","EC:6.3.2","EC:6.3.3",
"EC:6.3.4","EC:6.3.5","EC:6.4.1","EC:6.5.1","EC:6.6.1")

EC_subsubclass_list2 <- paste0(EC_subsubclass_list,".")

for (i in EC_subsubclass_list2) {
  name <- paste0("Sum.", substr(i, 1, nchar(i)-1))
  temp <- ECs %>%
    select(starts_with(i)) %>%
    mutate(!!name := rowSums(., na.rm=T)) %>%
    select(!starts_with(i))
  ECs[,name] <- as.vector(temp)
}

# format "otu" table for importing into phyloseq
EC_subsubclass_t <- t(ECs) %>% 
  row_to_names(row_number = 1)
EC_subsubclass_t <- as.matrix(EC_subsubclass_t)
EC_subsubclass_otu <- EC_subsubclass_t[2588:2807,]

# get EC names to match formatting of "tax" table
x <- row.names(EC_subsubclass_otu)
rownames(EC_subsubclass_otu) <- substring(x, 5)

EC_subsubclass_otu <- data.frame(EC_subsubclass_otu)
EC_subsubclass_otu_num <- lapply(EC_subsubclass_otu, as.numeric)
EC_subsubclass_otu_num <- data.frame(EC_subsubclass_otu_num)
rownames(EC_subsubclass_otu_num) <- rownames(EC_subsubclass_otu)

# replace colon with . so it matches taxa names in "tax" table
row.names(EC_subsubclass_otu_num) <- sub(':', '\\.', row.names(EC_subsubclass_otu_num))

sample_names <- ECs$SampleID
colnames(EC_subsubclass_otu_num) <- sample_names

OTU = otu_table(EC_subsubclass_otu_num, taxa_are_rows = TRUE)

# format sample data for importing into phyloseq
EC_sam <- ECs[,c(2:3,2440:2588)]
EC_sam <- column_to_rownames(EC_sam, var = "SampleID")
EC_sam$SHMI2_bin <- factor(EC_sam$SHMI2_bin, levels = c("very low","low","medium","high","very high"))
EC_sam$SH_bin <- factor(EC_sam$SH_bin, levels = c("very low","low","medium","high","very high"))

SAM <- sample_data(EC_sam)

# use the EC description as "taxa"
EC_desc <- read_xlsx("ec_files_expasy/enzclass_R.xlsx")
EC_desc <- column_to_rownames(EC_desc, var = "EC")
EC_desc <- as.matrix(EC_desc)
TAX <- tax_table(EC_desc)

# create phyloseq object
p_subsubclass <- phyloseq(OTU, TAX, SAM)

# bar chart
plot_bar(p_subsubclass, x = "SHMI2_bin", fill = "Family") +
  geom_bar(stat = "identity") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "SHMI Bin") +
  scale_fill_discrete(name = "Sub-subclass")
ggsave("figures/EC_abund_SHMI_subsubclass.pdf", unit = "in", width = 6, height = 4, dpi = 300, device = "pdf")

### looking at this I'm not sure I actually needed to do all this, and I maybe could've just changed the fill in the subclass graph?

plot_bar(p_subsubclass, x = "SH_bin", fill = "Family") +
  geom_bar(stat = "identity") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "SEMWISE Bin") +
  scale_fill_discrete(name = "Sub-subclass")
ggsave("figures/EC_abund_SEMWISE_subsubclass.pdf", unit = "in", width = 6, height = 4, dpi = 300, device = "pdf")

```

### Do the same as above but splitting by .
```{r}
ECs <- read.csv("machine_learning/EC_RA_corr/ml_EC_RA_corr.csv", check.names = FALSE)

ECs2 <- ECs[,4:2439]

# make a vector of names
EC_names <- names(ECs2)

new <- unique(vapply(strsplit(EC_names, '\\.'), function(x) 
            paste(x[1:2], collapse='.'), character(1L)))
new <- paste0(new, ".")

```

### PCOA at subsubclass level just to see what it looks like
```{r}
p_ord <- ordinate(p_subsubclass, "CCA", "bray")
plot_ordination(p_subsubclass, p_ord, "samples", color = "ClimateZ")

p_ord <- ordinate(p_subclass, "CCA", "bray")
plot_ordination(p_subclass, p_ord, "samples", color = "Current_Land_Use")

```






















