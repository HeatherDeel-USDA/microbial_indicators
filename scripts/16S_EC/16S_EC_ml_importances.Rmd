---
title: "16S_EC_ml_importances"
author: "Heather Deel"
date: "2023-11-08"
output: html_document
---

### Compiling variable importances for all EC models for all indicators

### Libraries
```{r}
library(tidyverse)
```

### Import importances for all indicators
# ACE
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/ACE_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-1]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# get list of features overlapping between all 25 dfs
ace_shared <- ldf %>% reduce(inner_join, by = "EC_number")

# calculate average importance of all shared features
ace_shared$avg_imp <- rowMeans(ace_shared[,2:26])
ace_shared <- ace_shared[,c(1,27)]
ace_shared <- data.frame(ace_shared)
colnames(ace_shared)[1] <- "feature"
ace_shared$indicator <- "ACE"

# add Gibbs info to important features
enzyme_list <- read.csv("ec_files_expasy/enzyme.csv")
enzyme_list$feature <- paste("EC_",enzyme_list$EC_number, sep = "")
enzyme_list$feature <- gsub("\\.","_", enzyme_list$feature)
enzyme_list <- enzyme_list[,2:3]
ace_info <- ace_shared %>% 
  left_join(enzyme_list, by = "feature")

# get NAs in EC_name to be the correct
ace_info[56,4] <- "clay"
ace_info[57,4] <- "Cfa"
ace_info[58,4] <- "Csa"
ace_info[59,4] <- "Dfc"

# ID features in our soil gibbs list
enzyme_gibbs <- read.csv("picrust2_files/GIBBs.EC.numbers.csv")
colnames(enzyme_gibbs)[1] <- "feature"
enzyme_gibbs$feature <- gsub("\\.","_", enzyme_gibbs$feature)
ace_info <- ace_info %>% 
  left_join(enzyme_gibbs, by = "feature")
ace_info$Category <- ace_info$Category %>% 
  replace_na("Unknown")

# graph all important features with gibbs features highlighted
p1 <- ggplot(ace_info, aes(x = reorder(EC_name, -avg_imp), y = avg_imp, fill = Category)) +
  geom_bar(stat = "identity", width = .5) +
  scale_fill_manual(values = c("#0023FF","#00AC10","#FF0000","#B5B5B5")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "ACE Important Features",
       y = "Average Importance Across 25 Models")
p1
ggsave("figures/feat_importance_EC_ACE.pdf", unit = "in", width = 8, height = 6, dpi = 300, device = "pdf")
```

# ACTIVE C
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/ACTIVEC_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-1]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# get list of features overlapping between all 25 dfs
activeC_shared <- ldf %>% reduce(inner_join, by = "EC_number")

# calculate average importance of all shared features
activeC_shared$avg_imp <- rowMeans(activeC_shared[,2:26])
activeC_shared <- activeC_shared[,c(1,27)]
activeC_shared <- data.frame(activeC_shared)
colnames(activeC_shared)[1] <- "feature"
activeC_shared$indicator <- "ACTIVEC"

# add Gibbs info to important features
enzyme_list <- read.csv("ec_files_expasy/enzyme.csv")
enzyme_list$feature <- paste("EC_",enzyme_list$EC_number, sep = "")
enzyme_list$feature <- gsub("\\.","_", enzyme_list$feature)
enzyme_list <- enzyme_list[,2:3]
activeC_info <- activeC_shared %>% 
  left_join(enzyme_list, by = "feature")

# get NAs in EC_name to be the correct
activeC_info[50,4] <- "Dfc"

# ID features in our soil gibbs list
activeC_info <- activeC_info %>% 
  left_join(enzyme_gibbs, by = "feature")
activeC_info$Category <- activeC_info$Category %>% 
  replace_na("Unknown")

# graph all important features with gibbs features highlighted
# there are no gibbs features in this one
p1 <- ggplot(activeC_info, aes(x = reorder(EC_name, -avg_imp), y = avg_imp, fill = Category)) +
  geom_bar(stat = "identity", width = .5) +
  scale_fill_manual(values = c("#B5B5B5")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Active C Important Features",
       y = "Average Importance Across 25 Models")
p1
ggsave("figures/feat_importance_EC_ACTIVEC.pdf", unit = "in", width = 8, height = 6, dpi = 300, device = "pdf")
```




##### edit here and below
# Aggregate Stability
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/AGGSTAB_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-1]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
aggstab_shared <- ldf %>% reduce(inner_join, by = "EC_number")
aggstab_shared <- aggstab_shared[,1]
aggstab_shared <- data.frame(aggstab_shared)
colnames(aggstab_shared)[1] <- "feature"
aggstab_shared$indicator <- "AGGSTAB"
```

# CASH
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/CASH_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
# note the position changed
ldf <- ldf[-26]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
cash_shared <- ldf %>% reduce(inner_join, by = "EC_number")
cash_shared <- cash_shared[,1]
cash_shared <- data.frame(cash_shared)
colnames(cash_shared)[1] <- "feature"
cash_shared$indicator <- "CASH"
```

# Disturbance
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/DIST_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-1]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
dist_shared <- ldf %>% reduce(inner_join, by = "EC_number")
dist_shared <- dist_shared[,1]
dist_shared <- data.frame(dist_shared)
colnames(dist_shared)[1] <- "feature"
dist_shared$indicator <- "DIST"
```

# Respiration
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/RESP_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-1]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
resp_shared <- ldf %>% reduce(inner_join, by = "EC_number")
resp_shared <- resp_shared[,1]
resp_shared <- data.frame(resp_shared)
colnames(resp_shared)[1] <- "feature"
resp_shared$indicator <- "RESP"
```

# Richness
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/RICH_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-1]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
rich_shared <- ldf %>% reduce(inner_join, by = "EC_number")
rich_shared <- rich_shared[,1]
rich_shared <- data.frame(rich_shared)
colnames(rich_shared)[1] <- "feature"
rich_shared$indicator <- "RICH"
```

# Roots
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/ROOT_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-1]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
root_shared <- ldf %>% reduce(inner_join, by = "EC_number")
root_shared <- root_shared[,1]
root_shared <- data.frame(root_shared)
colnames(root_shared)[1] <- "feature"
root_shared$indicator <- "ROOT"
```

# SEMWISE
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/SEMWISE_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-26]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
semwise_shared <- ldf %>% reduce(inner_join, by = "EC_number")
semwise_shared <- semwise_shared[,1]
semwise_shared <- data.frame(semwise_shared)
colnames(semwise_shared)[1] <- "feature"
semwise_shared$indicator <- "SEMWISE"
```

# SHMI
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/SHMI_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
# note the position change
ldf <- ldf[-26]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
shmi_shared <- ldf %>% reduce(inner_join, by = "EC_number")
shmi_shared <- shmi_shared[,1]
shmi_shared <- data.frame(shmi_shared)
colnames(shmi_shared)[1] <- "feature"
shmi_shared$indicator <- "SHMI"
```

# SOM
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/SOM_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-1]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
som_shared <- ldf %>% reduce(inner_join, by = "EC_number")
som_shared <- som_shared[,1]
som_shared <- data.frame(som_shared)
colnames(som_shared)[1] <- "feature"
som_shared$indicator <- "SOM"
```

# Water capacity
```{r}
# make list of file names
filenames = list.files(pattern="\\.csv$",
                  path = "machine_learning/16S_EC/WATERCAP_model_results_clay_climate",
                  full.names = T)
ldf <- lapply(filenames, read.csv)

# remove stats file from ldf
ldf <- ldf[-1]

# format column names
colnames <- c("EC_number","importance")
ldf <- lapply(ldf, setNames, colnames)

# filter out negative importances - neg importances reduce predictive value
ldf <- lapply(ldf, function(x) filter(x, importance > 0))

# calculate percent importances
for (i in seq_along(ldf)) {
  ldf[[i]]$importance <- as.numeric(ldf[[i]]$importance)
  sum <- sum(ldf[[i]]$importance)
  ldf[[i]]$importance_percent <- ldf[[i]]$importance / sum * 100
} 

# get features that make up top 50% of importance
ldf <- lapply(ldf, function(df){
  df[order(df$importance_percent),] #orders importance percentages
})

for (i in seq_along(ldf)) {
  ldf[[i]]$importance_percent_cumsum <- cumsum(ldf[[i]]$importance_percent) # cumulated sum of percentages
}

#ldf <- lapply(ldf, function(x) filter(x, importance_percent_cumsum > 50)) # filters cumulated sums < 50
# get rid of this line to include all features shared between all 25 models

# get list of features overlapping between all 25 dfs
watercap_shared <- ldf %>% reduce(inner_join, by = "EC_number")
watercap_shared <- watercap_shared[,1]
watercap_shared <- data.frame(watercap_shared)
colnames(watercap_shared)[1] <- "feature"
watercap_shared$indicator <- "WATERCAP"
```

### Combine shared features for all indicators
######## edit graphing of this later - need to fill bars by gibbs soil list category like above
```{r}
# still need to add disturbance, richness, and semwise once they are done in scinet

list_EC_dfs <- list(ace_shared, activec_shared, aggstab_shared, cash_shared,
                    dist_shared,resp_shared, rich_shared, root_shared, 
                    semwise_shared, shmi_shared, som_shared, watercap_shared)
ECs_shared <- list_EC_dfs %>% reduce(inner_join, by = "feature")

# there are no features shared by all 25 models for all indicators
# do a full join and count the number of indicators each feature is important in

ECs_all <- list_EC_dfs %>% reduce(full_join, by = "feature")
colnames_list <- c("feature","ACE","ACTIVEC","AGGSTAB","CASH","DIST","RESP",
                   "RICH","ROOT","SEMWISE","SHMI","SOM","WATERCAP")
colnames(ECs_all) <- colnames_list
ECs_all$num_indic_imp <- rowSums(!is.na(ECs_all[,2:13]))

# add info to list of ECs
enzyme_list <- read.csv("ec_files_expasy/enzyme.csv")
enzyme_list$feature <- paste("EC_",enzyme_list$EC_number, sep = "")
enzyme_list$feature <- gsub("\\.","_", enzyme_list$feature)
enzyme_list <- enzyme_list[,2:3]
ECs_all_info <- ECs_all %>% 
  left_join(enzyme_list, by = "feature")

# filter ECs_all down to features that were important in 4 or more indicators
ECs_all_filt <- filter(ECs_all_info, num_indic_imp > 3)

# get Nas in EC_name to be the climate zones
ECs_all_filt[2,15] <- "Cfa"
ECs_all_filt[9,15] <- "clay"
ECs_all_filt[22,15] <- "Dfc"
ECs_all_filt[25,15] <- "Csa"
ECs_all_filt[39,15] <- "Csb"
ECs_all_filt[40,15] <- "BSk"

p1 <- ggplot(ECs_all_filt, aes(x = reorder(EC_name, -num_indic_imp), y = num_indic_imp)) +
  geom_bar(stat = "identity", fill = "darkgreen") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Features Important in Four or More Indicators",
       y = "Number of Indicators Feature is Important In")
p1

```




