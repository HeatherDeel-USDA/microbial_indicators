---
title: "Machine Learning Graphing"
author: "Heather Deel"
date: "2023-09-18"
output: html_document
---

### Libraries
### make sure to clean these up, get rid of ones I don't use
```{r}
library(ggplot2)
library(readxl)
library(ggpubr)
library(paletteer)
library(tidyverse)
library(sjPlot)
library(cowplot)
library(janitor)
library(phyloseq)
library(M3C)
library(vegan)
library(cowplot)
library(grid)
library(gridExtra)
library(pairwiseAdonis)
library(ggcorrplot)
library(Hmisc)
library(rlist)
library(pipeR)
library(RColorBrewer)
library(png)
library(gplots)
library(dplyr)

# function to set the panel size of a multi-panel ggplot object
set_panel_size <- function (p=NULL, g=ggplotGrob(p), 
                            file=NULL, margin = unit(1,"mm"), 
                            width=unit(4, "cm"), height=unit(4, "cm")) {
  panels <- grep("panel", g$layout$name)
  panel_index_w<- unique(g$layout$l[panels])
  panel_index_h<- unique(g$layout$t[panels])
  nw <- length(panel_index_w)
  nh <- length(panel_index_h)
  
  if(getRversion() < "3.3.0") {
    g$widths <- grid:::unit.list(g$widths)
    g$heights <- grid:::unit.list(g$heights)
    g$widths[panel_index_w] <-  rep(list(width),  nw)
    g$heights[panel_index_h] <- rep(list(height), nh)
  } else {
    g$widths[panel_index_w] <-  rep(width,  nw)
    g$heights[panel_index_h] <- rep(height, nh)
  }
  if (!is.null(file)) {
    ggsave(file, g,
           width = convertWidth(sum(g$widths) + margin, unitTo = "in", valueOnly = TRUE),
           height = convertHeight(sum(g$heights) + margin, unitTo = "in", valueOnly = TRUE))
  }
  invisible(g)  
}
```

### Figure 1
# comparison of model observed vs predicted R^2 values
# need to rerun taxonomic models, with nutrient data
# then add to below plot
```{r}
# tax data was pulled from dan_out/All_stats_randomForest and added to All_stats.csv
ml_stats <- read.csv("machine_learning/16S_EC/All_stats.csv")
ml_stats2 <- filter(ml_stats, model_type == "RA" | model_type == "Total" | model_type == "RA_TAX")

#stat.test <- compare_means(r2_val ~ model_type,
#                           data = ml_stats2,
#                           method = "wilcox.test",
#                           p.adj='fdr', group.by = "myVar")

#stat.test$Comparison <- paste0(stat.test$myVar, " - ", stat.test$group1)
#groups <- rcompanion::cldList(p.adj ~ Comparison,
#                              data = stat.test,
#                              threshold = 0.05)
#groups$y <- 1
#groups <- groups[1:13,]
#groups$p.signif <- stat.test$p.signif

p1 <- ggplot(ml_stats2, aes(x=myVar, y=r2_val, fill = model_type)) + 
  geom_boxplot() + 
  xlab("Indicator") +
  ylab(bquote(R^2~"Values")) +
  theme_bw() + 
  ylim(0,1) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_fill_discrete(name = "Data Type", labels = c("RA EC", "RA TAX", "Total EC")) +
  scale_x_discrete(labels = c("ACE","Active C","Agg. Stab.","Fe","K","Mg","Mn","P",
                              "pH","Respiration","SOM","Water Capacity","Zn"))
  #geom_text(inherit.aes=F, data=groups, aes(x=Group, y=y, label=p.signif))
p1

#ggsave("figures/ml_r2.png", unit = "in", width = 10, height = 5, dpi = 300, device = "png")
```

### Figure 2
# functional redundancy in taxonomic models
```{r}
top_ECs <- readRDS('top_ECs.RDS')
top_TAX <- readRDS('top_TAX.RDS')

### graphs
myVars <- c("ace", "activeC", "agg_stab", "fe", "k", "mg", "mn", "p", "ph", "resp", "SOM", "water_cap", "zn")
pl <- list()
for (myVar in myVars) {
  # changing myVar format for cleaner plot titles
  if (myVar == 'resp'){
    myTitle <- "Resp"
  }
  if (myVar == 'agg_stab'){
    myTitle <- "AggStab"
  }
  if (myVar == 'water_cap'){
    myTitle <- "WaterCap"
  }
  if (myVar == 'mg'){
    myTitle <- "Mg"
  }
  if (myVar == 'mn'){
    myTitle <- "Mn"
  }
  if (myVar == 'zn'){
    myTitle <- "Zn"
  }
  if (myVar == 'ace'){
    myTitle <- "ACE"
  }
  if (myVar == 'activeC'){
    myTitle <- "ActiveC"
  }
  if (myVar == 'ph'){
    myTitle <- "pH"
  }
  if (myVar == 'p'){
    myTitle <- "P"
  }
  if (myVar == 'k'){
    myTitle <- "K"
  }
  if (myVar == 'fe'){
    myTitle <- "Fe"
  }
  if (myVar == 'SOM'){
    myTitle <- "SOM"
  }
  
  # subset data by indicator, taxa, and ECs of interest
  indicator.ECs <- top_ECs %>%
    filter(Indicator == myVar) %>%
    arrange(desc(EC.VIP)) %>%
    top_n(10, EC.VIP)

  indicator.TAX <- top_TAX %>%
    filter(Indicator == myVar) %>%
    arrange(desc(TAX.VIP)) %>%
    select(Indicator, Kingdom, Phylum, Class, Order, Family, Genus, Species2, 
           TAX.VIP, Runs, any_of(indicator.ECs$EC)) %>%
    top_n(10, TAX.VIP)
  
  indicator.TAX.long <- indicator.TAX %>%
    pivot_longer(cols=starts_with("EC."), names_to="EC", values_to="Copies")
  
  gDF <- indicator.ECs %>%
    left_join(indicator.TAX.long, by="EC")
  gDF["Copies"][gDF["Copies"] == 0] <- NA
  
  # create heatmaps
  library(forcats)
  p2 <- ggplot(gDF, aes(x = fct_reorder(EC, EC.VIP, .desc=TRUE, .na_rm=FALSE), 
                        y = fct_reorder(Species2, TAX.VIP, .desc=TRUE, .na_rm=FALSE), fill = Copies)) +
    geom_tile(color='grey20') +
    #geom_text(aes(label=round(Copies,3)), size=2) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 6),
          axis.text.y = element_text(size = 6),
          legend.text = element_text(size = 8)) +
    scale_fill_binned(type="viridis", direction=-1,
                      breaks = c(1,2,3,4,5,6),
                      #labels=c("(0,1]","(1,2]","(2,3]","(3,4]",
                      #         "(4,5]","(5,6]"),
                      limits=c(0,6)) +
  labs(x = "", y = "", title = myTitle, fill = "Enzyme Copies")
  
  if (myTitle == "SOM") {
    legend = get_legend(p2)
    ggsave(plot=legend, "../figures/heatmap_dkm/legend.png", device='png', dpi=600,
           height=3, width=2)
  }
  
  p2 <- p2 + theme(legend.position = "none")
  p2 <- set_panel_size(p2, height=unit(3, "in"), width=unit(3, "in"))
  ggsave(paste0("../figures/heatmap_dkm/ez_copies_per_species_heatmap_", myTitle,".png"), 
         device='png', dpi=600, height=4, width=6)
  pl[[myTitle]] <- p2
}

# create merged plot of heatmaps
p_heatmap_all <- marrangeGrob(pl, top=NULL, layout_matrix = matrix(1:16,  nrow = 4, ncol=4, byrow=TRUE))
ggsave(plot=p_heatmap_all, "../figures/heatmap_dkm/ez_copies_per_species_heatmap.png", 
       device='png', dpi=600, height=17, width=20)
```


### Figure 3
# PCOAs using tsne
# output EC and taxonomy statistics to a file 
```{r}
### EC data PCOA
########### need to redo this with all enzymes, not just gibbs
P <- readRDS('machine_learning/EC_RA_corr/ml_EC_RA_corr.RDS')

data <- P[,3:2438]

meta <- P
meta <- meta[,c(1:2,2439:2587)]

p1 <- M3C::tsne(t(data), labels=FALSE, dotsize = 0, seed=1234, perplex=15) + theme_bw() +
  geom_point(aes(fill=meta$ClimateZ, shape=meta$Current_Land_Use), size=4) +
  scale_shape_manual(values=c(21,22,23,24), labels = c("Annual Cropland","Perennial Cropland","Rangeland")) +
  guides(size="none",
         fill = guide_legend(override.aes = list(size = 4, shape=21))) +
  labs(fill="Climate Zone", shape="Land Use", x="tSNE 1", y="tSNE 2", title = "Enzyme Data")
p1
ggsave(paste0("figures/All_enzymes_RA_corr_tSNE.png"), device='png', dpi=600, height=4, width=6)

# permanova between land use and climate zone
permanova_land <- pairwise.adonis2(data ~ Current_Land_Use,
                                data = meta,
                                permutations = 9999)
# p-vals for all comparisons less than 0.05

permanova_climate <- pairwise.adonis2(data ~ ClimateZ,
                                data = meta,
                                permutations = 9999)
# p-vals for all comparisons less than 0.05

### taxa data PCOA
P <- readRDS('machine_learning/16S_TAX/ml_TAX_16S.RDS')

data <- P[,152:7614]

meta <- P
meta <- meta[,1:151]

p2 <- M3C::tsne(t(data), labels=FALSE, dotsize = 0, seed=1234, perplex=15) + theme_bw() +
  geom_point(aes(fill=meta$ClimateZ, shape=meta$Current_Land_Use), size=4) +
  scale_shape_manual(values=c(21,22,23,24), labels = c("Annual Cropland","Perennial Cropland","Rangeland")) +
  guides(size="none",
         fill = guide_legend(override.aes = list(size = 4, shape=21))) +
  labs(fill="Climate Zone", shape="Land Use", x="tSNE 1", y="tSNE 2", title = "Taxa Data")
p2
ggsave(paste0("figures/TAX_RA_tSNE.png"), device='png', dpi=600, height=4, width=6)

# permanova between land use and climate zone
permanova_land <- pairwise.adonis2(data ~ Current_Land_Use,
                                data = meta,
                                permutations = 9999)
# p-vals for all comparisons less than 0.05

permanova_climate <- pairwise.adonis2(data ~ ClimateZ,
                                data = meta,
                                permutations = 9999)
# p-vals for all comparisons less than 0.05

# can output permanova results to a file to compare how well enzyme data and taxa data distinguishes between land use and climate zones - compare R^2 and F statistics

p_pcoa <- ggarrange(p1, p2, common.legend = TRUE, nrow = 1, ncol = 2)
p_pcoa
ggsave(paste0("figures/EC_TAX_RA_tSNE.png"), device='png', dpi=600, height=4, width=8.2)
```


### Figure 4 and Figure 5
# Feature importance distributions of indicators with all enzyme models
# separating by positively (Figure 4) and negatively (Figure 5) correlated enzymes
######## commenting out gibbs stuff for now
```{r}
myVars <- c('SOM', 'resp', 'agg_stab', 'water_cap', 'mg', 'mn', 'zn', 'ace', 'activeC', 'ph', 'p', 'k','fe')

for (myVar in myVars) {
     filenames <- list.files(paste0("machine_learning/16S_EC/",myVar,"_model_results_RA_corr/"), pattern = paste0(myVar,"_RA_corr_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>% 
    reduce(full_join)
  
  names(varimps_full) <- c('Predictor', 'VIP', 'Run')
  varimps_full$Predictor <- gsub("EC_","EC:", varimps_full$Predictor)
  varimps_full$Predictor <- gsub("_","\\.", varimps_full$Predictor)
  
 # gibbs <- read.csv("picrust2_files/GIBBs.EC.numbers.csv", header = TRUE)

 gDF <- varimps_full %>%
    #left_join(gibbs, by=c("Predictor"="EC")) %>% 
    mutate(Predictor=fct_reorder(Predictor, VIP, .fun=median, .desc=TRUE))

 # calculate positive and negative correlations between enzymes and indicators
 ml_EC_RA_corr <- readRDS('machine_learning/EC_RA_corr/ml_EC_RA_corr.RDS')
 
 # putting some indicators into their own loops since climateZ, clay, DNA not all found in them
 if (myVar == 'p') {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(DNA))
 }
 
 if (myVar == 'ph') {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(clay))
 }
 
 if (myVar == 'zn') {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(clay, DNA))
 }
 
 if (myVar == 'fe') {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(ClimateZ))
 }
 
 if (myVar %in% c('SOM', 'resp', 'agg_stab', 'water_cap', 'mg', 'mn', 'ace', 'activeC', 'k')) {
  ml_indic <- ml_EC_RA_corr %>% 
    select(gDF$Predictor, paste0(myVar)) %>% 
    subset(select=-c(ClimateZ, clay, DNA))
 }
 
 ml_indic <- as.matrix(ml_indic)
 ec.mat <- rcorr(ml_indic)
 ec.r <- ec.mat$r
 ec.indic <- ec.r %>% 
   subset(select = paste0(myVar))
 ec.indic <- data.frame(ec.indic)
 
 ############# format ec.indic and write most important ECs to a file
 ec.indic2 <- rownames_to_column(ec.indic, var = "Predictor")
 gDF2 <- gDF %>% 
   filter(Predictor %in% ec.indic2$Predictor)
 temp2 <- gDF2 %>% group_by(Predictor) %>%
   summarise(Var = median(VIP)) %>%
   top_n(10, Var)
 gDF2 <- gDF2 %>%
   filter(Predictor %in% temp2$Predictor)
   # write important variables to a csv file
 gDF2.grouped <- gDF2 %>% 
   group_by(Predictor) %>% 
   summarise(mean_VIP = mean(VIP)) %>% 
   mutate(indicator = myVar)

 #write.table(gDF2.grouped, "machine_learning/16S_EC/top_ECs.csv", sep = ",",
              #append = TRUE, row.names = FALSE, col.names = FALSE)

 # format ec.indic but separate by positive and negative correlation values
 ec.indic.pos <- ec.indic %>% 
   filter(ec.indic[,1] > 0)
 ec.indic.neg <- ec.indic %>% 
   filter(ec.indic[,1] < 0)
 ec.indic.pos <- rownames_to_column(ec.indic.pos, var = "Predictor")
 ec.indic.neg <- rownames_to_column(ec.indic.neg, var = "Predictor")
 ec.indic.pos <- ec.indic.pos[ec.indic.pos$Predictor != myVar,]
 ec.indic.neg <- ec.indic.neg[ec.indic.neg$Predictor != myVar,]

  # filter out poor indicators in pos and neg correlations
  # add this if I want to include climate, clay, and DNA:
  # | Predictor %in% c('clay','ClimateZ','DNA')
 gDF.pos <- gDF %>% 
   filter(Predictor %in% ec.indic.pos$Predictor) 
 gDF.neg <- gDF %>% 
   filter(Predictor %in% ec.indic.neg$Predictor) 
 
  temp.pos <- gDF.pos %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(10, Var) 
  temp.neg <- gDF.neg %>% group_by(Predictor) %>%
    summarise(Var = median(VIP)) %>%
    top_n(10, Var) 
  
  gDF.pos <- gDF.pos %>%
    filter(Predictor %in% temp.pos$Predictor)
  gDF.neg <- gDF.neg %>%
    filter(Predictor %in% temp.neg$Predictor)
  
  # colors for gibbs categories
  # colors <- c("Biocontrol" = "#1F77B4FF",
  #             "C cycling" = "#FF7F0EFF",
  #             "C/N cycling" = "#2CA02CFF",
  #             "N cycling" = "#D62728FF",
  #             "P cycling" = "#9467BDFF",
  #             "S cycling" = "#8C564BFF",
  #             "Stress" = "#E377C2FF",
  #             "Siderophore" = "#7F7F7FFF",
  #             "NA" = "white")
  
  # changing myVar format for cleaner plot titles
  if (myVar == 'resp'){
    myVar <- "Resp"
  }
  if (myVar == 'agg_stab'){
    myVar <- "AggStab"
  }
  if (myVar == 'water_cap'){
    myVar <- "WaterCap"
  }
  if (myVar == 'mg'){
    myVar <- "Mg"
  }
  if (myVar == 'mn'){
    myVar <- "Mn"
  }
  if (myVar == 'zn'){
    myVar <- "Zn"
  }
  if (myVar == 'ace'){
    myVar <- "ACE"
  }
  if (myVar == 'activeC'){
    myVar <- "ActiveC"
  }
  if (myVar == 'ph'){
    myVar <- "pH"
  }
  if (myVar == 'p'){
    myVar <- "P"
  }
  if (myVar == 'k'){
    myVar <- "K"
  }
  if (myVar == 'fe'){
    myVar <- "Fe"
  }
  # positive correlation graph
  means <- aggregate(VIP ~ Predictor, gDF.pos, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p.pos <- ggplot(gDF.pos, aes(x=Predictor, y=VIP)) +
    #scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot(alpha = 1, fatten = 1) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), 
          legend.position = "none", plot.title = element_text(size = 12)) +
    labs(x="", y="", title = myVar)
  p.pos
  assign(paste0(myVar,"_pos"),p.pos)
  ggsave(paste0("figures/varimps/", myVar, "_RA_corr_varimp.pos.png"), device='png', dpi=600, height=8, width=8)
  
  # negative correlation graph
  means <- aggregate(VIP ~ Predictor, gDF.neg, median)
  means$Category <- 'Other'
  means$VIP <- round(means$VIP, 3)
  p.neg <- ggplot(gDF.neg, aes(x=Predictor, y=VIP)) +
    #scale_fill_manual(values=colors, na.value="white") +
    geom_boxplot(alpha = 1, fatten = 1) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), 
          legend.position = "none", plot.title = element_text(size = 12)) +
    labs(x="", y="", title = myVar)
  p.neg
  assign(paste0(myVar,"_neg"),p.neg)
  ggsave(paste0("figures/varimps/", myVar, "_RA_corr_varimp.neg.png"), device='png', dpi=600, height=8, width=8)
}

# create legend of all GIBBs colors to add to merged plot
# p_legend <- ggplot(gibbs, aes(x = EC, fill = Category)) +
#   scale_fill_manual(values = colors) +
#   geom_boxplot()
# p_legend
# p_legend2 <- get_legend(p_legend)
# p_legend3 <- as_ggplot(p_legend2)
# p_legend3

# positive correlations graph
p_merged_pos <- ggarrange(ACE_pos, ActiveC_pos, AggStab_pos, 
                          Fe_pos, K_pos, Mg_pos, Mn_pos, 
                          P_pos, pH_pos, Resp_pos, 
                          SOM_pos, WaterCap_pos, Zn_pos, 
                          nrow = 2, ncol = 7)
p_merged_pos

annotate_figure(p_merged_pos, left = text_grob("Variable Importance", rot = 90, vjust = 1, size = 14))

ggsave("figures/all_enzyme_varimps_pos.png", device='png', dpi=600, height=6, width=12)

# negative correlations graph
p_merged_neg <- ggarrange(ACE_neg, ActiveC_neg, AggStab_neg, 
                          Fe_neg, K_neg, Mg_neg, Mn_neg, 
                          P_neg, pH_neg, Resp_neg, 
                          SOM_neg, WaterCap_neg, Zn_neg,
                          nrow = 2, ncol = 7)
p_merged_neg

annotate_figure(p_merged_neg, left = text_grob("Variable Importance", rot = 90, vjust = 1, size = 14))

ggsave("figures/all_enzyme_varimps_neg.png", device='png', dpi=600, height=6, width=12)
```


### All Taxa
```{r}
myVars <- c('SOM', 'resp', 'agg_stab', 'water_cap', 'mg', 'mn', 'zn', 'ace', 'activeC', 'ph', 'p', 'k','fe')
for (myVar in myVars) {
  filenames <- list.files(paste0("../machine_learning/16S_TAX/", myVar,"_model_results_RA_TAX/"), 
                          pattern = paste0(myVar,"_RA_TAX_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>%
    reduce(full_join)
  names(varimps_full) <- c('Predictor', 'VIP', 'Run')

 gDF <- varimps_full %>%
   filter(Predictor != "ClimateZ" & Predictor != "clay" & Predictor != "DNA") %>%
   group_by(Predictor) %>%
   summarise(VIP = signif(mean(VIP),3),
             n=n()) %>%
   filter(n == 25)
  gDF$indicator <- myVar
  
  write.table(gDF, "../machine_learning/16S_TAX/top_TAX_All.csv", sep = ",",
              append = TRUE, row.names = FALSE, col.names = FALSE)
}
```


### All enzymes
```{r}
myVars <- c('SOM', 'resp', 'agg_stab', 'water_cap', 'mg', 'mn', 'zn', 'ace', 'activeC', 'ph', 'p', 'k','fe')
for (myVar in myVars) {
  filenames <- list.files(paste0("../machine_learning/16S_EC/", myVar,"_model_results_RA_corr/"), 
                          pattern = paste0(myVar,"_RA_corr_varimp*"), full.names = TRUE)
  varimps <- lapply(filenames, read.csv, header = FALSE)
  varimps_full <- varimps %>%
    reduce(full_join)
  names(varimps_full) <- c('Predictor', 'VIP', 'Run')

 gDF <- varimps_full %>%
   filter(Predictor != "ClimateZ" & Predictor != "clay" & Predictor != "DNA") %>%
   group_by(Predictor) %>%
   summarise(VIP = signif(mean(VIP),3),
             n=n()) %>%
   filter(n == 25)
  
  gDF$indicator <- myVar
  
  write.table(gDF, "../machine_learning/16S_EC/top_ECs_All.csv", sep = ",",
              append = TRUE, row.names = FALSE, col.names = FALSE)
}
```


### All significant Enzymes & Taxa
```{r}
### import important ECs
top_ECs <- read.csv("../machine_learning/16S_EC/top_ECs_All.csv", header = FALSE)
colnames(top_ECs) <- c("EC", "EC.VIP", "Runs", "Indicator")
top_ECs$EC <- gsub("EC:", "EC.", top_ECs$EC) 
top_ECs$EC <- gsub("_", "\\.", top_ECs$EC) 

### import important Taxa
top_TAX <- read.csv("../machine_learning/16S_TAX/top_TAX_All.csv", header = FALSE)
colnames(top_TAX) <- c("species", "TAX.VIP", "Runs", "Indicator")

### import picrust2 copy number data for each data set - to add to top_TAX
hops2018.picrust <- read_tsv("../picrust2_files/Hops.2018/EC_predicted_and_nsti.tsv")
hops2018.picrust$study <- "hops.2018"
hopsARS.picrust <- read_tsv("../picrust2_files/Hops.ARS/EC_predicted_and_nsti.tsv")
hopsARS.picrust$study <- "hops.ARS"
NRCS.picrust <- read_tsv("../picrust2_files/NRCS/EC_predicted_and_nsti.tsv")
NRCS.picrust$study <- "NRCS"
rangeland.picrust <- read_tsv("../picrust2_files/Rangeland/EC_predicted_and_nsti.tsv")
rangeland.picrust$study <- "rangeland"

picrust.all <- bind_rows(hops2018.picrust, hopsARS.picrust, NRCS.picrust, rangeland.picrust)
picrust.all$sequence <- gsub("OTU", "", picrust.all$sequence)  # get rid of "OTU" in taxon column
colnames(picrust.all)[1] <- "OTU_ID"

# select only picrust data for ECs of interest
wanted <- c("study", "OTU_ID", unique(top_ECs$EC))
picrust.select <- picrust.all[,wanted]
picrust.select$OTU_ID <- as.numeric(picrust.select$OTU_ID)

# get taxonomy data from all runs
hops2018.otuid <- read.delim("../16S_dada2_output/Hops.2018.taxonomy.otuid.csv", sep = ",")
hops2018.otuid$study <- "hops.2018"
hopsARS.otuid <- read.delim("../16S_dada2_output/Hops.ARS.taxonomy.otuid.csv", sep = ",")
hopsARS.otuid$study <- "hops.ARS"
NRCS.otuid <- read.delim("../16S_dada2_output/NRCS.taxonomy.otuid.csv", sep = ",")
NRCS.otuid$study <- "NRCS"
rangeland.otuid <- read.delim("../16S_dada2_output/Rangeland.taxonomy.otuid.csv", sep = ",")
rangeland.otuid$study <- "rangeland"
otuid <- rbind(hops2018.otuid, hopsARS.otuid, NRCS.otuid, rangeland.otuid)

otuid <- otuid %>%
  separate(species, into=c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep=";") %>%
  select(study, tax_ID, OTU_ID, Kingdom, Phylum, Class, Order, Family, Genus, Species) %>%
  mutate(Species2 = Species) %>%
  mutate(Species = gsub("\\(", "_", Species)) %>%
  mutate(Species = gsub("\\)", "_", Species)) %>%
  mutate(Species = gsub("\\.", "_", Species)) %>%
  mutate(Species = gsub("\\-", "_", Species)) %>%
  mutate(Species = gsub(" ", "_", Species))

top_TAX <- top_TAX %>%
  left_join(otuid, by=c("species" = "Species"))

top_TAX <- top_TAX %>%
  left_join(picrust.select, by=c("study", "OTU_ID")) %>%
  drop_na() %>% # if not present in a study values will be NA, so remove
  select(-study, -OTU_ID, -tax_ID, -species)

top_TAX <- top_TAX %>%
  group_by(Indicator, Kingdom, Phylum, Class, Order, Family, Genus, Species2) %>%
  summarise_if(is.numeric, mean, na.rm=TRUE) %>%
  ungroup()

saveRDS(top_ECs, 'top_ECs.RDS')
saveRDS(top_TAX, 'top_TAX.RDS')
#_________________________

myVars <- c("ace", "activeC", "agg_stab", "fe", "k", "mg", "mn", "p", "ph", "resp", "SOM", "water_cap", "zn")
for (myVar in myVars) {
  # subset data by indicator, taxa, and ECs of interest
  top_ECs.sub <- top_ECs %>%
    filter(Indicator == myVar) %>%
    arrange(desc(EC.VIP))
  write.csv(top_ECs.sub, paste0("../figures/top_predictors/top_ECs.", myVar, ".csv"))
  
  top_TAX.sub <- top_TAX %>%
    filter(Indicator == myVar) %>%
    arrange(desc(TAX.VIP)) %>%
    select(Indicator, Kingdom, Phylum, Class, Order, Family, Genus, Species2, 
           TAX.VIP, Runs, any_of(top_ECs.sub$EC))
  write.csv(top_TAX.sub, paste0("../figures/top_predictors/top_TAX.", myVar, ".csv"))
}

l
```

```{r}
library(data.tree)
# download json from 'https://www.kegg.jp/kegg-bin/get_htext?ko00001.keg'
json_data <- readr::read_file("ko00001.json")
yaml <- yaml::yaml.load(json_data)

tree <- as.Node(yaml)
test <- as.data.frame(tree)


write.csv(test, 'pathways.csv')
```



